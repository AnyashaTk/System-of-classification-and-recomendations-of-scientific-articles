text,space_num
"                                              MNRAS 000, 1‚Äì22 (2015)                                              Preprint 6 January 2021               Compiled using MNRAS LATEX style file v3.0",46.0
                                              A Composite Likelihood Approach for Inference under Photometric,46.0
                                              Redshift Uncertainty,46.0
"                                              M. M. Rau1‚òÖ , C. B. Morrison2 , S. J. Schmidt4 , S. Wilson3 , R. Mandelbaum1 ,",46.0
                                              Y.-Y.,46.0
                                              1,46.0
                                                    Mao5 for the LSST Dark Energy Science Collaboration,52.0
"                                                McWilliams Center for Cosmology, Department of Physics, Carnegie Mellon University, Pittsburgh, PA 15213",48.0
"                                              2 Department  of Astronomy, University of Washington, Box 351580, Seattle, WA 98195, USA",46.0
"                                              3 School of Computer Science and Statistics, Lloyd Institute, Trinity College, Dublin, Ireland",46.0
"                                              4 Department of Physics, University of California, Davis, CA 95616, USA",46.0
arXiv:2101.01184v1 [astro-ph.CO] 4 Jan 2021,0.0
"                                              5 Department of Physics and Astronomy, Rutgers, The State University of New Jersey, Piscataway, NJ 08854, USA",46.0
                                              Accepted XXX. Received YYY; in original form ZZZ,46.0
                                                                                    ABSTRACT,84.0
                                                                                    Obtaining accurately calibrated redshift distributions of photometric samples is one of the great,84.0
"                                                                                    challenges in photometric surveys like LSST, Euclid, HSC, KiDS, and DES. We combine the",84.0
"                                                                                    redshift information from the galaxy photometry with constraints from two-point functions,",84.0
                                                                                    utilizing cross-correlations with spatially overlapping spectroscopic samples. Our likelihood,84.0
                                                                                    framework is designed to integrate directly into a typical large-scale structure and weak lensing,84.0
                                                                                    analysis based on two-point functions. We discuss efficient and accurate inference techniques,84.0
                                                                                    that allow us to scale the method to the large samples of galaxies to be expected in LSST.,84.0
"                                                                                    We consider statistical challenges like the parametrization of redshift systematics, discuss and",84.0
"                                                                                    evaluate techniques to regularize the sample redshift distributions, and investigate techniques",84.0
                                                                                    that can help to detect and calibrate sources of systematic error using posterior predictive,84.0
                                                                                    checks. We evaluate and forecast photometric redshift performance using data from the Cos-,84.0
"                                                                                    moDC2 simulations, within which we mimic a DESI-like spectroscopic calibration sample for",84.0
"                                                                                    cross-correlations. Using a combination of spatial cross-correlations and photometry, we show",84.0
                                                                                    that we can provide calibration of the mean of the sample redshift distribution to an accuracy,84.0
"                                                                                    of at least 0.002(1 + ùëß), consistent with the LSST-Y1 science requirements for weak lensing",84.0
                                                                                    and large-scale structure probes.,84.0
                                                                                    Key words: keyword1 ‚Äì keyword2 ‚Äì keyword3,84.0
                                              1    INTRODUCTION                                                             the broadband photometry of galaxies allows for a limited accuracy,46.0
"                                                                                                                            in the estimated redshifts. In photometric surveys, we therefore typ-",124.0
                                              With ongoing and future large area photometric surveys like the,46.0
                                                                                                                            ically consider two-point statistics of density fields that have been,124.0
"                                              Dark Energy Survey (DES; e.g., Abbott et al. 2018b), the Kilo-",46.0
"                                                                                                                            projected along the line-of-sight, i.e., in the redshift direction. They",124.0
"                                              Degree Survey (KiDS; e.g., Hildebrandt et al. 2017), the Hyper",46.0
                                                                                                                            are then subsequently compared with the corresponding weak lens-,124.0
"                                              Suprime-Cam (HSC; e.g., Aihara et al. 2018), the Rubin Observa-",46.0
                                                                                                                            ing (WL) and large scale structure (LSS) theory predictions in a,124.0
"                                              tory Legacy Survey of Space and Time (LSST; e.g., Iveziƒá et al.",46.0
                                                                                                                            likelihood framework. These theory predictions have to account for,124.0
"                                              2019), the Roman Space Telescope (e.g. Spergel et al. 2015) and",46.0
"                                                                                                                            the line-of-sight projection, and therefore depend on the redshift",124.0
                                              Euclid (e.g. Laureƒ≥s et al. 2011) modern cosmology has entered,46.0
                                                                                                                            distribution of the galaxies in the sample that have to be accurately,124.0
"                                              the era of precision cosmology, where it becomes increasingly im-",46.0
                                                                                                                            modelled and calibrated (see e.g. Huterer et al. 2006; Hoyle et al.,124.0
                                              portant to accurately account for sources of systematic bias and,46.0
                                                                                                                            2018; Tanaka et al. 2018; Hildebrandt et al. 2020; Joudaki et al.,124.0
                                              uncertainty (e.g. Mandelbaum 2018). Large area photometric sur-,46.0
                                                                                                                            2020).,124.0
                                              veys constrain cosmological parameters and the growth of structure,46.0
                                                                                                                                  A primary goal of large area photometric survey programs is to,130.0
                                              using two-point statistics of galaxy and shear fields (see e.g. Hilde-,46.0
"                                                                                                                            map the growth of structure and expansion history of the Universe,",124.0
                                              brandt et al. 2017; Uitert et al. 2017; Abbott et al. 2018a; Joudaki,46.0
                                                                                                                            and thereby constrain the dark energy equation of state via the,124.0
                                              et al. 2018; Hikage et al. 2019; Heymans et al. 2020). Using only,46.0
"                                                                                                                            distance-redshift and growth-redshift relations (see e.g., Albrecht",124.0
"                                                                                                                            et al. 2006, p. 31) which both enter the WL and LSS modelling.",124.0
                                                                                                                            Note that these fundamental relationships within our cosmological,124.0
"                                              ‚òÖ   E-mail: markusr@andrew.cmu.edu                                            model are redshift dependent, as are some key sources of theoret-",46.0
                                              ¬© 2015 The Authors,46.0
avr_spaces,74.83582089552239
2,0.0
"ical uncertainty, such as the galaxy-dark matter bias model (see        In contrast, template-based redshift inference requires a complete set",0.0
e.g. Matarrese et al. 1997; Clerkin et al. 2015; Chang et al. 2016;     of templates but no calibration sample. Checking a fitted model can,0.0
"Simon & Hilbert 2018; Prat et al. 2018). The inferred ensemble          also, in principle, use the color space alone, by comparing the pho-",0.0
redshift distributions for samples of galaxies can therefore exhibit a  tometry generated by the fitted templates with the measurements. In,0.0
degeneracy with cosmological or astrophysical parameters. Inaccu-       practice this approach has limitations. The generation of SED model,0.0
"rate distance, or redshift, measurements based on the photometry of     templates is challenging and often requires spectroscopic reference",0.0
"the galaxies are therefore important modelling systematics in these     data for some galaxies. Furthermore, degeneracies between galaxy",0.0
surveys (e.g. Ma et al. 2006; Bernstein & Huterer 2010). We there-      type and galaxy redshift can make the aforementioned color-based,0.0
"fore must exploit all data sources that have the potential to break     approach ill-defined. Thus, while template fitting does not require",0.0
"these degeneracies to perform efficient and accurate inference.         spectroscopic data to infer redshifts of galaxies, in practise it is of-",0.0
"      The two methods available to constrain the redshift of galaxies   ten necessary for building and evaluating models. Finally, empirical",6.0
in the absence of accurate spectroscopic measurements are ‚Äòtem-         techniques that construct photometric redshift estimates by ‚Äòlearn-,0.0
plate fitting‚Äô methods and empirical methods that ‚Äòlearn‚Äô the map-      ing‚Äô from a spectroscopic calibration dataset require reference data,0.0
"ping between photometry and redshift (for a recent review, see          that does not have to spatially overlap, but needs to be representative",0.0
Salvato et al. 2019). SED fitting methods fit the galaxy photome-       in color-redshift space.,0.0
"try with models of the galaxy spectral energy distribution (SED;              Besides spatial correlations of galaxy clustering, we can also",0.0
"e.g., Arnouts et al. 1999; Ben√≠tez 2000; Ilbert et al. 2006; Feld-      use other two-point statistics from e.g., weak gravitational lensing",0.0
mann et al. 2006; Greisel et al. 2015; Leistedt et al. 2016; Malz &     (e.g. Benjamin et al. 2013; St√∂lzner et al. 2020). There also exists,0.0
Hogg 2020). Machine Learning-based methods infer photometric            a considerable literature in how photometric redshift uncertainty,0.0
redshifts by constructing a density estimate for the conditional dis-   can be treated in the individual cosmological probes (McLeod et al.,0.0
tribution of the galaxy redshifts given their photometry (Tagliaferri   2017; Hoyle & Rau 2019) or how one can combine template fitting,0.0
et al. 2003; Collister & Lahav 2004; Gerdes et al. 2010; Carrasco       and cross correlation measurements (Alarcon et al. 2020b; S√°nchez,0.0
Kind & Brunner 2013; Bonnett 2015; Rau et al. 2015; Hoyle 2016).        & Bernstein 2019; Jones & Heavens 2019; Rau et al. 2020). Shortly,0.0
Combinations of both these techniques have also been investigated       before this paper was submitted for publication Myles et al. (2020);,0.0
(Speagle & Eisenstein 2015; Hoyle et al. 2015). Unfortunately the       Gatti et al. (2020); Cawthon et al. (2020) presented the redshift,0.0
"accuracy of these techniques is limited since they suffer from differ-  inference scheme for the DES Y3 analyses, that combines a cross-",0.0
ent sources of systematic error. Template fitting approaches can be     correlation and shear ratio data vector with redshift information,0.0
"systematically biased, if fits are constructed using sets of spectral   derived using an empirical mapping of broad band ‚ÄòWide field‚Äô",0.0
energy distributions that are not representative of all galaxies in the photometry to spatially smaller calibration fields with narrow-band,0.0
"sample. In contrast, photometric redshift techniques that require a     photometric and spectroscopic redshift information.",0.0
training set can produce systematically biased results due to incom-          This paper presents a composite likelihood approach to jointly,0.0
plete spectroscopic training samples. It is particularly difficult to   constrain photometric redshift distributions using information from,0.0
obtain representative spectroscopic data due to the long exposure       both the available photometry and the clustering of galaxies. We,0.0
"times that are necessary to obtain accurate spectroscopic redshifts     focus on statistical challenges in this inference. In particular, the",0.0
for faint sources (see e.g. Huterer et al. 2014; Newman et al. 2015).   parts of the model that utilize the photometry of galaxies can pose,0.0
"      Instead of inferring photometric redshifts by fitting models      computational challenges, since the likelihood depends on mea-",6.0
"for the spectral energy distribution, we can also infer photometric     surements of all galaxies in the sample. We therefore derive an effi-",0.0
redshift infromation using spatial cross-correlations between pho-      cient methodology that facilitates inference of redshift distributions,0.0
tometric samples and spectroscopic samples (e.g. Newman 2008;           within this computationally expensive part of the model. Redshift,0.0
M√©nard et al. 2013; McQuinn & White 2013; Scottez et al. 2016;          inference based on noisy photometry is an inverse problem and the,0.0
Raccanelli et al. 2017; Morrison et al. 2017; Davis et al. 2017; Gatti  inference scheme requires careful regularization to achieve good,0.0
et al. 2018). Cross-correlation methods measure the spatial cross       probability coverage. We therefore describe several regularization,0.0
correlation between a reference sample with accurate redshift infor-    techniques and evaluate their respective merits in numerical exper-,0.0
"mation, typically spectroscopic galaxy catalogs, and photometric        iments. Information from the spatial distribution of galaxies can",0.0
samples that do not have accurate redshift information. Ignoring        then be incorporated within the composite likelihood framework,0.0
cosmic magnification effects (see e.g. Scranton et al. 2005) the        by efficient MCMC sampling. We test our methodology using data,0.0
expected spatial cross correlation is only nonzero for samples at       from the CosmoDC2 (Korytov et al. 2019) simulated extragalac-,0.0
the same redshift. By cross correlating subsamples of spectroscopic     tic catalog. While some of the inference techniques developed in,0.0
samples that are selected in thin redshift slices with these photomet-  this paper can also be used in the context of an empirical mapping,0.0
"ric catalogs and comparing the resulting signals, we can reconstruct    to a small-area calibration field, our primary goal is to facilitate",0.0
the redshift distribution of the unknown photometric sample.            inference using physical SED modelling that utilizes a likelihood,0.0
      It is important to highlight the different sources of systematic  that jointly describes photometry and spatial information for all ob-,6.0
uncertainty in these two approaches: the measurement of spatial         served galaxies. Inference under spatial variations in photometry or,0.0
cross correlations requires that the sample with unknown redshift       redshift information will be addressed in the course of the paper,0.0
information and the reference sample overlap spatially and cover the    and in ¬ß 10.,0.0
"same redshift range. However, the spectroscopic calibration sample            The paper is structured as follows: ¬ß 2 describes the simu-",0.0
"does not have to cover the same color/magnitude space as the un-        lated galaxy samples used in this work, while ¬ß 3 gives a brief",0.0
"known photometric sample. It is, however, important to accurately       introduction into inverse problems and deconvolution by discussing",0.0
model the redshift-dependent galaxy-dark matter bias of the photo-      a simple toy model for photometric redshift inference. The fol-,0.0
"metric sample and the spectroscopic calibration sample, since the       lowing sections describe our inference methodology in detail: ¬ß 4",0.0
"redshift-dependent ratio between these two functions is completely      starts with a description of the photometric likelihood, where we",0.0
"degenerate with the photometric redshift distribution to be inferred.   also discuss several regularization schemes, and ¬ß 5 formulates the",0.0
"                                                                                                                      MNRAS 000, 1‚Äì22 (2015)",118.0
avr_spaces,2.0923076923076924
                                                                              Likelihood Inference under Photo-z error                      3,78.0
"cross-correlation likelihood. Both of these parts are then combined     type/SED and apparent magnitude in the redshift estimation, though",0.0
in a composite likelihood framework in ¬ß 6. ¬ß 7 discusses aspects       we do not employ the prior in this investigation.,0.0
of model evaluation and parametrization of systematics. We then               To construct a template set we begin with the empirical SED,0.0
apply our methodology to the simulated data in ¬ß 8. ¬ß 9 summarizes      catalog of Brown et al. (2014). We then use the ESP software pack-,0.0
"our findings. ¬ß 10 closes the paper with a discussion of future work.   age (Kalmbach & Connolly 2017), which constructs a principal",0.0
                                                                        component basis set from the empirical SEDs and uses photomet-,72.0
                                                                        ric training data to construct the final SED template via Gaussian,72.0
                                                                        Processes. The final training set used by BPZ consists of the 129,72.0
2    SIMULATED GALAXY SAMPLES                                           empirical templates and 100 additional templates output from ESP.,0.0
"We use data from the CosmoDC2 simulated extragalactic catalog           These templates roughly, but not perfectly, span the observed range",0.0
(Korytov et al. 2019) in this work. CosmoDC2 is a mock extragalac-      of colors for the sample. We compute the likelihoods for all SEDs by,0.0
tic catalog based on a trillion particle N-body simulation with a box   comparing the observed fluxes to model fluxes evaluated on a grid of,0.0
"size of 4.225 Gpc3 , the ‚ÄòOuter Rim‚Äô run (Heitmann et al. 2019). The    redshift spanning 0 < ùëß < 3. The 1-dimensional marginalized (over",0.0
simulated catalog covers 440 deg2 of sky area and spans a redshift      template type) posterior distributions for each galaxy comprise our,0.0
range 0 < ùëß ‚â§ 3. Galaxies are assigned to the halo catalog and          final template fitting redshift estimate.,0.0
supplemented with additional galaxies based on the assumption of,0.0
a power law extrapolation of a power law sub-halo mass function at      Machine Learning-based Redshifts We use the python version of,0.0
lower masses. The resulting catalog exhibits a number count slope       the publicly available FlexCode2 (Izbicki & Lee 2017) combined,0.0
consistent with that of the Hyper SuprimeCam Deep survey (Aihara        with the XGBoost algorithm (Chen & Guestrin 2016) to compute,0.0
"et al. 2018) down to an r-band magnitude of r ‚àº 28, well beyond         photometric redshifts which we will refer to by the name FlexZ-",0.0
the apparent magnitudes that will be utilized in this paper. The        Boost. FlexZBoost estimates the conditional density in redshift,0.0
galaxy catalog uses a combination of empirical and semi-analytic        for each galaxy by fitting to an orthonormal set of basis functions,0.0
"modelling, utilizing the Galacticus (Benson 2012) and GalSampler        (in this case cosines) via regression with XGBoost. To further re-",0.0
"codes (Hearin et al. 2020). For more details on the catalog genera-     fine the estimates, 25 per cent of the training data is reserved as",0.0
tion and properties we refer the reader to Korytov et al. (2019).       a validation set to determine optimal values for trimming extrane-,0.0
"      In ¬ß 2.1 we will describe the particular selection of photometric ous low-level peaks in the likelihood, and a ‚Äúsharpening"" parameter",6.0
data and the photometric redshift catalog used in this work. ¬ß 2.2      of the form ùëù(ùëß) ‚àù ùëù(ùëß) ùõº that adjusts the overall width of the,0.0
describes the generation of the reference spectroscopic sample.         density estimates to best match the data. For this analysis we use,0.0
"                                                                        35 cosine basis functions, and a sharpening parameter, chosen via",72.0
"                                                                        cross-validation, of 1.4. Given the representative training data used",72.0
"2.1    Photometric Sample and Photometric Redshift Catalog              in this experiment, we expect very accurate redshift estimates from",0.0
                                                                        the FlexZBoost algorithm.,72.0
The photometric sample consists of mock galaxies from the LSST-,0.0
"DESC ‚ÄúCosmoDC2"" synthetic sky catalog (Korytov et al. 2019).",0.0
"The catalogs do not contain stars or AGN, so star-galaxy separation     2.2    Spectroscopic Sample",0.0
and non-thermal contamination are not an issue in this data set.,0.0
"                                                                        The simulated reference spectroscopic sample is selected to mimic,",72.0
Observations consist of magnitudes in the six ùë¢ùëîùëüùëñùëßùë¶ Rubin Ob-,0.0
"                                                                        in broad strokes, the sample selections of the Dark Energy Spec-",72.0
servatory filters. Simulated photometric errors were added to the,0.0
"                                                                        trosopic Instrument (DESI, DESI Collaboration et al. 2016, Zhou",72.0
six bands using a simple model designed to match the expected,0.0
"                                                                        et al. 2020a, Zhou et al. 2020b). This consists of a set of four sam-",72.0
"photometric S/N due to depth, seeing, airmass, and sky brightness",0.0
                                                                        ples with increasing mean redshift: a magnitude-limited sample to,72.0
at the completion of the full 10-year Wide Fast Deep survey (Iveziƒá,0.0
                                                                        ùëü LSST < 19.5; a Luminous Red Galaxy (LRG) sample; an Emis-,72.0
"et al. 2019). All galaxies are assumed to be isolated, i.e. blending",0.0
                                                                        sion Line Galaxy (ELG) sample; and finally a high-redshift Quasar,72.0
effects are not modeled. We restrict the sample to galaxies with,0.0
                                                                        (QSO) sample. We show the redshift and ùëñLSST -band magnitude dis-,72.0
an ùëñ LSST -band magnitude of ùëñ LSST < 25.0 that corresponds to a,0.0
"                                                                        tributions of these subsamples in Fig. 1. The LRG, ELG, and QSO",72.0
point source ùëñ LSST -band signal-to-noise (S/N) of ‚àº 20. We make,0.0
                                                                        samples are selected such that their density per redshift matches,72.0
this cut because redshift estimates for lower S/N objects degrade,0.0
                                                                        that of the DESI samples (priv. comm. Rongpu Zhou and Jeffrey,72.0
rapidly below this S/N level. We reserve a small set of ‚àº 100000,0.0
                                                                        Newman). This sample is distinct from the redshift calibration data,72.0
galaxies for training of the photo-z algorithms; this training set is,0.0
                                                                        mentioned in the previous section.,72.0
"a random subset of the ùëñ LSST < 25.0 sample, and thus completely",0.0
"                                                                              We construct a magnitude-limited sample, by imposing a mag-",78.0
"representative of the underlying galaxy distribution, so no modeling",0.0
"                                                                        nitude cut of ùëü LSST < 19.5. To approximate the LRG, ELG and QSO",72.0
of spectroscopic incompleteness effects is necessary.,0.0
"                                                                        galaxy samples, we use the values of the stellar mass, star forma-",72.0
"                                                                        tion rate, and black hole mass times Eddington ratio as proxies for",72.0
"Template Fitting Redshifts We use the publicly available Bayesian       objects that are LRG, ELG, and QSO-like respectively. Our goal",0.0
photometric redshift code BPZ1 (Ben√≠tez 2000) to compute redshift       with these samples is to select galaxies that will have differing bias,0.0
estimates for our simulated galaxies. BPZ is a template-based red-      properties and mimic the complexities of the DESI sample in this,0.0
"shift estimation code that estimates redshift by computing model        regard, while matching the density and signal-to-noise we would",0.0
fluxes from a set of template SEDs and evaluating the resulting ùúí2      expect with a DESI-like sample. We thus use these simple truth,0.0
when compared to observed fluxes. BPZ includes the optional ap-         quantities from the simulation rather than recreate the full color,0.0
"plication of a bivariate Bayesian prior over the joint distribution of  selection of a true, simulated DESI sample. The QSO, ELG, and",0.0
1  available at: http://www.stsci.edu/~dcoe/BPZ/                        2  available at https://github.com/tpospisi/flexcode,0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,22.10126582278481
4,0.0
Figure 1. Left: Redshift probability density functions of the galaxy populations that constitute the DESI-like spectroscopic reference sample. Right:,0.0
Corresponding i-band magnitude distributions.,0.0
"LRG samples are all selected with ùëü LSST > 19.5, to be independent",0.0
"of the magnitude-limited sample. Additionally, QSOs and ELGs are",0.0
selected to have ùëü LSST < 23.4 and LRGs have the cut ùëß LSST < 23.0            Zùëù = Z + ùùê .                                                                 (1),0.0
applied to them. QSOs are selected by ordering the candidate QSOs             The probability     densities3   associated with these random variables,0.0
in a redshift bin by the product of their black hole mass and black           are:,0.0
"hole Eddington ratio, cutting on the value when the density of QSOs",0.0
matches the expected DESI density for a given redshift range. This             ùëç ùëó ‚àº ùëùùëß                                                                    (2),0.0
process is repeated for ELGs using their star formation rate in the              ùëù      ùëù,0.0
                                                                              ùëçùëó    ‚àº ùëùùëß                                                                   (3),78.0
simulation as a proxy for ‚ÄúELG-ness‚Äù. We also impose the condition,0.0
"that the candidate ELGs have a black hole mass times Eddington                  ùúñ ùëó ‚àº ùëùùúñ ,                                                                 (4)",0.0
"ratio below what we cut on for the QSOs, to assure that the sam-",0.0
"ples are independent. This process of rank-ordering and selecting             where ùëó ‚àà {1, . . . , ùëÅ gal } and ‚Äò‚àº‚Äô connects the realization of a ran-",0.0
the top galaxies until we achieve the expected DESI density is re-            dom variable on the left hand side with the probability density,0.0
"peated again for the LRGs, this time with stellar mass as our proxy           function (PDF) on the right hand side from which this realization is",0.0
value. Both the ELG star formation and QSO selection are excluded             drawn.,0.0
"from the LRG selection, ensuring that the samples are independent.                   The random variable ùúñ ùëó is assumed to be identically and in-",0.0
"We calculate values for these cuts on a ‚àº50 deg2 test area in the             dependently distributed, as well as independent of ùëç ùëó . These as-",0.0
"CosmoDC2 simulations and apply them to the full 300 deg2 area.                sumptions do not hold in the photometric redshift scenario, as the",0.0
"                                                                              noise very clearly depends on the color, and therefore redshift, of",78.0
"                                                                              the galaxy. However, in the following toy model, we adopt these as-",78.0
                                                                              sumptions for simplicity. The theory can be easily extended towards,78.0
3   INTRODUCTION TO DECONVOLUTION PROBLEMS                                    input-dependent noise (see e.g. Meister 2009) without changing the,0.0
                                                                              intuition presented in this section.,78.0
"As we will see in detail in the following sections, the photometric                  In order to derive an estimator for ùëù ùëß , we use the convolution",0.0
"redshift problem is a deconvolution problem, where the redshift               theorem4 that connects the PDF of the sum of independent random",0.0
distribution of a sample of photometrically observed galaxies is              variables with the convolution of their densities. We can therefore,0.0
inferred from their noisy photometric measurements. To give the               write:,0.0
"reader an intuitive understanding of deconvolution problems, we",0.0
                                                                                                  ‚à´                             ‚à´,98.0
present a short introduction into the classical deconvolution prob-              ùëù,0.0
"                                                                              ùëùùëß = ùëùùëß ‚àó ùëù ùúñ =         ùëù ùëß (ùëß ùëù ‚àí ùëß) ùëù ùúñ (ùëß)dùëß =      ùëù ùúñ (ùëß ùëù ‚àí ùëß) ùëù ùëß (ùëß) dùëß ,",78.0
lem. A similar description in the context of photometric redshift,0.0
estimation can be found in Padmanabhan et al. (2005). We close this                                                                                        (5),0.0
section by discussing the limitations of the toy model considered,0.0
here and motivate the likelihood inference framework presented in,0.0
the following.                                                                3                                                 ùëù,0.0
                                                                                 Note that the probability densities ùëùùëß and ùëùùëß are both redshift distribu-,81.0
                                                                                                                                  ùëù,130.0
"                                                                              tions of samples of galaxies. They differ since ( ùëùùëß , ùëùùëß ) denotes the sample",78.0
"                                                                              distribution of (photometric, true or spectroscopic) galaxy redshifts. Thus",78.0
3.1   A Toy Model                                                                ùëù,0.0
"                                                                              ùëùùëß would be broader, since the error in the redshift, drawn from ùëù ùúñ , is",78.0
                                                                              convolved with the true redshift.,78.0
"Consider three vectors of random variables Z, Z ùëù and ùùê with di-              4 A Fourier-based approach is not necessary. Concretely, the likelihood",0.0
"mension ùëÅgal , which denotes the photometric sample size. Z and               framework presented in the following section works in real space. A Fourier",0.0
"Z ùëù denote the true and photometric redshifts of the galaxies in the          description for the classical deconvolution problem is, however, analytically",0.0
sample and ùùê the residual error between both quantities. The addi-            tractable and provides a clear picture of the nature of the problem and the,0.0
tive noise model that connects these random variables is given as:            importance of regularization.,0.0
"                                                                                                                                 MNRAS 000, 1‚Äì22 (2015)",129.0
avr_spaces,22.555555555555557
                                                                                                  Likelihood Inference under Photo-z error                       5,98.0
       The Fourier transform of a probability distribution is the char-                    non-vanishing ùêæ ft . The bandwidth parameter governs the tradeoff,7.0
"acteristic function. We will denote the characteristic functions of                        between the bias, or ‚Äòsmoothness‚Äô, of the density estimate, and its",0.0
"         ùëù                         p,ft",9.0
"(ùëù ùëß , ùëù ùëß , ùëù ùúñ ) as (ùëù ftùëß , ùëù ùëß , ùëù ftùúñ ). Given a sample drawn from a PDF,             variance. Choosing a larger bandwidth washes out small scale noise",0.0
"e.g., the sample of photometric redshifts of ùëÅgal galaxies, we can                         in the reconstructed density. In the limit of vanishing bandwidth,",0.0
"               p,ft                                                                        we would again obtain an ill-posed inverse Fourier transformation.",15.0
estimate ùëù ùëß          as5,0.0
"                                                                                                  In the following sections, we will apply regularization tech-",98.0
                        ùëÅgal,24.0
"  p,ft            1 ‚àëÔ∏Å               ",2.0
                                              ùëù,46.0
"                                                                                          niques that restrict the functional form of the redshift distribution,",49.0
ùëùÀÜ ùëß (ùë°)   =                    exp ùëñùë°ùëç ùëó .                                            (6) following a similar idea as presented in closed form in Eq. (10) for,0.0
                ùëÅgal,16.0
                         ùëó=1                                                               the classical deconvolution problem.,25.0
The argument ùë° of the characteristic function could be interpreted,0.0
as a kind of redshift-frequency if we treat the redshift of a galaxy as,0.0
a ‚Äòtime parameter‚Äô. Under the assumption of independence between                           3.2     Towards the Photometric Redshift Problem,0.0
Z and ùúñ we can write:                                                                      We note that inverse problems like the classical deconvolution prob-,0.0
"  p,ft",2.0
ùëù ùëß (ùë°)    =   ùëùÀÜftùëß (ùë°) ùëùÀÜftùúñ (ùë°) =   ùëù ftùëß (ùë°) ùëù ftùúñ (ùë°) .                           (7) lem also appear in several other scenarios like the measurements,0.0
"                                                                                           of shapes, where the point-spread function (PSF) of galaxies con-",91.0
Therefore an estimator for                 ùëù ftùëß (ùë°)   is given as:                        volves the galaxies‚Äô light profiles and leads to a loss of information.,0.0
                                 ùëÅ,33.0
                                                                                           While the considered toy model of the photometric redshift problem,91.0
                                   gal                   ,35.0
   ùëìùë°                  1         ‚àëÔ∏Å,3.0
"                                                        ùëù                                  is analytically tractable, it does not describe the realistic situation.",56.0
"ùëùÀÜ ùëß (ùë°) =                             exp ùëñùë°ùëç ùëó ,                                     (8)",0.0
              ùëù ftùúñ (ùë°)ùëÅgal ùëó=1                                                            Besides the relatively simple extension towards a galaxy-dependent,14.0
"                                                                                           photometric noise, the noise distribution ùëù ùúñ is, in photometric red-",91.0
"where we assume ùëù ftùúñ (ùë°) is known and nonzero everywhere. We note                         shift estimation, given as a joint likelihood between the photometry",0.0
"that this estimator is consistent and unbiased (Meister 2009). The                         of all galaxies in the sample, that depends on the additional pa-",0.0
error term ùëù ftùúñ (ùë°) here acts as a ‚Äòfilter‚Äô to weight down small scale                    rameters that enter the SED modelling. The redshift of each galaxy,0.0
"modes in the distribution. However, we note that this term 1/ùëù ftùúñ can                     is a parameter that enters its likelihood and the sample redshift",0.0
"become large when ùëù ftùúñ is small.                                                          distribution is its prior. Furthermore, the model does not properly",0.0
       As a consequence the inverse Fourier transform                                      account for the spatial distribution of galaxies. The clustering of,7.0
"                    ‚à´                                                                      galaxies does not only constrain their redshift distribution, but con-",20.0
              1                               ùëìùë°,14.0
"ùëù ùëß (ùëß) =               exp (‚àíùëñùë°ùëß) ùëùÀÜ ùëß (ùë°) dùë° ,                                       (9) nects to SED modelling, with nuisance parameters that describe,",0.0
             2ùúã,13.0
"                                                                                           e.g., galaxy-dark matter bias.",91.0
is neither integrable nor square integrable. Loosely speaking this                                We structure the discussion of the likelihoods used in this work,0.0
implies that the parameter space that describes the shape of ùëù ùëß (ùëß)                       in practice based on the following roadmap: we first describe our,0.0
does not have to be bounded. We will see this effect also for the more                     likelihood framework for the photometry of galaxies given a set of,0.0
complex model considered in the later sections of this work. We                            templates in ¬ß 4. We reiterate that in contrast to the classical de-,0.0
"reiterate that while the estimator of ùëùÀÜftùëß has very desirable properties,                 convolution problem, the ‚Äòerror distribution‚Äô in the full photometric",0.0
"the inverse transformation is not well defined, hence deconvolution                        redshift problem is based on the joint photometric likelihood. We",0.0
problems are part of a larger class of ‚Äòinverse problems‚Äô.                                 will therefore base our estimator and inference on this likelihood,0.0
"       In order to obtain well-defined results, we therefore have to per-                  instead of the characteristic function. Despite these methodological",7.0
"form regularization either by regulating the shape/parametrization                         differences, we note that the necessity for regularization is the same",0.0
       ùëù,7.0
"of ùëù ùëß (e.g. using Kernel methods), projecting ùëù ùëß onto a suitable                         as in the analytically tractable classical deconvolution problem. The",0.0
"basis like wavelet functions or by directly restricting the 1/ùëù ftùúñ term,                  considered regularization schemes are described in ¬ß 4.2. A partic-",0.0
"as implemented in a Ridge method (e.g. Meister 2009, ¬ß 2.2.3).                             ular challenge in the context of large area photometric surveys is",0.0
We will not discuss the details of these methods and refer to the                          the necessity to scale the inference to a large number of galaxies. In,0.0
"literature for a more detailed explanation (e.g. Meister 2009). It is,                     Appendices ¬ß A and ¬ß B we derive an efficient inference framework",0.0
"however, instructive to study the functional form of one of these reg-                     based on the Laplace approximation that facilitates fast probabilistic",0.0
ularized estimators. Making the ansatz of a kernel density estimate                        deconvolution. We will use this deconvolution methodology in the,0.0
"for the photometric redshift PDF, one can show that the deconvolved                        following sections ¬ß 4 to ¬ß 8.",0.0
density ùëùÀÜ ùëß can be estimated as (e.g. Meister 2009):,0.0
                    ‚à´                                      !      ùëÅgal,20.0
              1                              ùêæ ft (ùë°ùëè)        1 ‚àëÔ∏Å        ,14.0
                                                                               ùëù,79.0
                                                                                 ,81.0
                                                                                           4     PHOTOMETRIC LIKELIHOOD,91.0
"ùëùÀÜ ùëß (ùëß) =              exp (‚àíùëñùë°ùëß)                                     exp ùëñùë°ùëç ùëó dùë° ,",0.0
             2ùúã                                 ùëù ftùúñ (ùë°)    ùëÅgal,13.0
                                                                  ùëó=1,66.0
                                                                                           The spectral energy distributions of distant galaxies are a complex,91.0
                                                                                      (10) superposition of spectral components from their stellar populations.,86.0
where ùëè denotes the bandwidth and ùêæ ft the fourier transform of                                   The SED of the galaxy can be uniquely mapped to a given,0.0
"the kernel function that enters the kernel density estimation ansatz                       redshift ùëß, which allows us to predict the galaxy flux as a function",0.0
        ùëù,8.0
for ùëù ùëß . We see that by restricting the shape of the density ùëù ùëß,0.0
                                                                                         ùëù of redshift in a given optical filter band F (ùúÜ) by,89.0
                                                                                                        ‚à´,104.0
to a kernel density estimate whose smoothness is governed by the,0.0
"parameter ùëè, we regularize the 1/ùëù ftùúñ (ùë°) term by a multiplicative fac-                    ùëìùëñ (ùëß, ùõº) =    F (ùúÜ) SEDùúÜ (ùúÜ, ùëß, ùõº) dùúÜ .                           (11)",0.0
"tor, that renders the inverse Fourier transformation both integrable",0.0
"                                                                                           where SEDùúÜ (ùúÜ,         is",91.0
"                                                                                                            ùëß, ùõº)   the Spectral Energy Distribution template",107.0
"and square integrable assuming bounded, compactly supported and",0.0
                                                                                           in units of erg cm2 s √Ö. The parameter ùõº denotes additional free,91.0
"                                                                                           parameters in the SED template models, such as galaxy age, type, or",91.0
"5   Here,ÀÜdenotes an estimator for the respective function.                                red continuum slope. For a given set of photometric filters F (ùúÜ) we",0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,23.43820224719101
6,0.0
                                                                                     redshift bins. The vector œÄ ùë© has the properties ùëñ=1,85.0
                                                                                                                                                √ç ùëÅtot ùêµ,144.0
obtain a mapping between the redshift ùëß of the galaxy and a vector                                                                                      ùúãùëñ = 1 and,0.0
"of fluxes f. We will denote this mapping as T (ùëß, ùõº).                                0 ‚â§ ùúãùëñùêµ ‚â§ 1, and therefore lies on the simplex. Our first choice",0.0
       Assuming that the measurements of photometry for different                    for a distribution on the simplex for ùëù(ùùÖ ùë© ) (and therefore ùëù(n ùêµ )),7.0
galaxies are independent6 we can make the ansatz for the joint                       was the Dirichlet distribution7 . During the course of this project we,0.0
likelihood of fluxes of a galaxy sample FÃÇ                                           have applied a mean field variational inference scheme that uses the,0.0
               ùëÅgal,15.0
               √ñ                                                                     Dirichlet as the variational distribution as well as a Gibbs sampling,15.0
"ùëù( FÃÇ|z, ùú∂) =       N ( fÃÇi |T (ùëß ùëñ , ùõºùëñ ), ùö∫ùëñ ) .                              (12) scheme based on the Dirichlet-Multinomial cojugacy for posterior",0.0
               ùëñ=1                                                                   inference. We found that the variational inference scheme yielded,15.0
"Here, ùö∫ùíä denotes the measurement covariance matrix of the flux                       underestimated error bars, likely due to the restricted covariance",0.0
"measurements fÃÇi , and FÃÇ denotes the set of all flux measurements                   structure of the dirichlet. Moreover, the sampling approach did not",0.0
"of the galaxies. We assume Gaussian uncertainties here, where                        scale well to the large galaxy samples expected for the first-year",0.0
"N (ùë•, ùúá, Œ£) denotes the Normal distribution. The parameter ùõº can                     LSST observations. Specifically, the computational workload to up-",0.0
"either be a galaxy-specific index that selects a certain template from               date redshift variables for 106 ‚àí 1010 galaxies seems very large, and",0.0
"a pre-specified number of models, or a physical property of galaxies.                while subsampling techniques provide a possible mitigation, they",0.0
       The prior on the parameters ùëß and ùõº must account for their                    can lead to biased inferences (Quiroz et al. 2018). Furthermore the,7.0
correlation. An example for a possible parametrization in the case                   application of sampling techniques requires a sufficiently large trace,0.0
of a galaxy-specific template index would be a two-dimensional                       to ensure convergence. This can be difficult to ensure in this case.,0.0
"histogram. However, other parametrizations are possible, especially                  In order to provide a more flexible distributional ansatz than the",0.0
"if additional parameters that change the shape of the base templates                 dirichlet, while still maintaining the computational advantages of",0.0
"are included in the template set. In this work, we will consider the                 a mean field variational inference scheme, we decided to develop",0.0
"simplest case, where we use a multidimensional histogram prior                       a scheme that is based on the logit-normal distribution (Atchison",0.0
"where each histogram cell denotes a combination of redshift bin                      & Shen 1980), as explained in the following section. While these",0.0
"and discretized ùõº parameter value, that for example could indicate                   considerations motivate our choice of method, we note that this",0.0
a template selection. The histogram index ùëñ runs over all histogram                  should not discredit alternative approaches based on sampling or,0.0
"bins {ùëñ : 0 < ùëñ ‚â§ ùëÅtot }, where ùëÅtot = ùëÅbins √ó ùëÅparameters . The                     variational inference in general. We will perform a more detailed",0.0
"prior on the corresponding histogram heights, denoted as ùëõùëñùêµ cor-                    analysis of convergence and probability coverage of multiple infer-",0.0
"responding to the interval ùêºùëñ in the ùëß ‚àí ùõº parameter space, reads:                   ence techniques in future work.",0.0
            ùëÅtot,12.0
            ‚àëÔ∏Å                                                                       4.1    Photometric Redshift inference,12.0
"ùëù(ùëß, ùõº) =        ùëõùëñùêµ [(ùëß, ùõº) ‚àà ùêºùëñ ] .                                           (13)",0.0
            ùëñ=1                                                                      The problem specified by Eq. (14) is a deconvolution problem that,12.0
"Here [ùêæ] denotes the Iverson bracket, that is (0, 1) if the proposition              extends the simple toy model considered in ¬ß 3. The ‚Äònoise‚Äô PDF is",0.0
"ùêæ is (false, true). We note that nB parametrizes the joint distribution              now given by a joint likelihood that can depend on a complex set",0.0
"of redshift histograms and ùú∂ parameter. For simplicity we will in                    of parameters. Furthermore, while the discussion in ¬ß 3 focused on",0.0
"the following omit the marginalization over ùú∂ and refer to nB as the                 deriving an estimator for the deconvolved density, the focus here is",0.0
parameters of the sample redshift distribution. The reason is that in                to infer posteriors using efficient inference techniques. We present,0.0
this paper we do not add additional parameters to parametrize the                    the detailed description and derivation of the inference pipeline in,0.0
SEDs over which we need to marginalize. In applications like weak                    Appendices A and B. The final form of Eq. (14) is then given in the,0.0
gravitational lensing and galaxy clustering we are mainly interested                 form of a logit-normal posterior:,0.0
"in estimating the redshift distribution of a sample of galaxies, here",0.0
                                                                                                        1                1,104.0
referred to as the base sample and parametrized by the vector nB .                   ùëù(nB | FÃÇ) ‚âà ‚àöÔ∏Å                    √é ùëÅbins ùêµ,0.0
It is therefore useful to marginalize over the redshifts of individual                               |2ùúãùö∫y | Œîùëß ùëÅbins             ùëõùëñ,0.0
                                                                                                                           ùëñ=1,123.0
                                                                                                                    !            !                         !         !!,116.0
galaxies. We note that if the posterior of individual galaxy redshifts,0.0
                                                                                              1          ùíè ùë© ‚àíNbins                  ‚àí1         ùíè ùë© ‚àíNbins,94.0
"is important, we can always post-sample using the final posterior                     exp ‚àí log                       ‚àí ùùÅy,ML ùö∫y log                         ‚àí ùùÅy,ML ,",0.0
"on nB , based on Eq. (34), that then also includes information from",0.0
                                                                                              2            ùëõùêµ,94.0
                                                                                                            ùëÅ                                     ùëõùêµùëÅ,108.0
                                                                                                              bins                                   bins,110.0
galaxy clustering. The posterior distribution of the sample redshift                                                                                            (16),0.0
distribution given FÃÇ is then:,0.0
                                                                                     where Œîùëß denotes the histogram bin width. The estimation of the,85.0
                      ùëÅgal ‚à´ ‚àû,22.0
"                      √ñ                                                              covariance ùö∫y and mean vector ùùÅy,ML are detailed in Appendices",22.0
"ùëù(nB | FÃÇ) ‚àù ùëù(nB )                  dùëß ùëñ ùëù(ùëß ùëñ |nB ) N ( fÃÇi |T (ùëß ùëñ ), Œ£ùëñ ) . (14) A and B. However, we note that this formalism derives the hessian",0.0
                              0,30.0
                      ùëñ=1                                                            H = ‚àíùö∫ùíö ‚àí1 and obtaining the covariance matrix ùö∫ùíö requires matrix,22.0
       Discretizing the integral and using Eq. (13) we obtain                        inversion. The subscript ‚Äòy‚Äô here refers to the variable transforma-,7.0
                      ùëÅgal ‚àëÔ∏ÅùëÅtot      ‚à´ ùëßùëó                                          tion:,22.0
                      √ñ                      ùëÖ,22.0
"ùëù(nB | FÃÇ) ‚àù ùëù(nB )               ùëõBùëó          dùëß ùëñ ùëù( fÃÇi |T (ùëß ùëñ ), Œ£ùëñ ) .",0.0
                                                                                                                                                  ,94.0
                                           ùëó,43.0
"                                                                                (15) y(ùùÖ) = log (ùúã1 /ùúã ùëÅbins ), . . . , log (ùúã ùëÅbins ‚àí1 /ùúã ùëÅbins ) ,            (17)",80.0
                      ùëñ=1 ùëó=1            ùëßùêø,22.0
                                             ,45.0
 The histogram heights ùëõùëñùêµ = ùúãùëñùêµ Œîùëß can be expressed as the ra-,1.0
                                                                                     7,85.0
"tio between œÄ and the histogram width Œîùëß, assuming equal-sized                          The Dirichlet is the conjugate prior to the multinominal distribution, which",0.0
"                                                                                     can make sampling and inference easier. Concretely, if a Dirichlet prior is set",85.0
"                                                                                     on the probabilities of the multinomial likelihood (which are its parameters),",85.0
6  This assumption can be violated due to effects such as blending of nearby         the posterior over these probabilities is again a Dirichlet. However conjugacy,0.0
galaxy light profiles on flux calibration errors..                                   does not imply that the prior is ideal in all circumstances.,0.0
"                                                                                                                                         MNRAS 000, 1‚Äì22 (2015)",137.0
avr_spaces,24.170731707317074
                                                                                                        Likelihood Inference under Photo-z error                                                   7,104.0
that we discuss in more detail in Appendix B. The vector nB ‚àíùëÅbins                                                                  1.4                                        True Distribution,0.0
denotes here the vector of nB excluding the last entry ùëõN,0.0
                                                                                      Sample Photometric Redshift Distribution nB,86.0
"                                                           ùêµ , where",59.0
                                                                                                                                                                               Fiducial,175.0
we assume equal sized redshift histogram bin width.,0.0
                                                             bins,61.0
                                                                                                                                    1.2                                        Merging Bin,132.0
"     Like the classical deconvolution problem, the inference of",5.0
                                                                                                                                    1.0,132.0
Eq. (14) is an inverse problem. We can therefore expect that there,0.0
"exists a parameter vector ùùÖ ‚àà Œî, where Œî denotes the simplex                                                                        0.8",0.0
"space, that has a high likelihood (relative to the maximum likeli-",0.0
"hood value), but a large distance from the true ùùÖ opt .                                                                             0.6",0.0
"     Furthermore, as we have seen in ¬ß 3, the solutions of inverse",5.0
"problems do not have to be bounded8 (or even well defined), which                                                                   0.4",0.0
"implies that uncertainties can be arbitrarily large (see, e.g., Kuusela                                                             0.2",0.0
"2016). Regularization, detailed in the following section, is therefore",0.0
a key aspect in our inference pipeline.                                                                                             0.0,0.0
                                                                                                                                          0.0   0.5   1.0      1.5       2.0      2.5        3.0,138.0
                                                                                                                                                            Redshift z,156.0
4.2     Regularization                                                            Figure 2. Illustration of the impact of the ‚ÄòMerging Bin‚Äô regularization,0.0
                                                                                  on the posterior of the sample photometric redshift distribution. We show,82.0
"In this section we describe techniques that we employ to regularize9              1ùúé intervals. The x-axis shows the redshift value ùëß, the y-axis the value of",0.0
"the deconvolution problem. As instabilities arise when the histogram              the nB parameters. The errorbars are the [16, 84] percentiles, which would",0.0
width is of the same order as the uncertainty in the redshift of the              correspond to 1ùúé intervals for a normal distribution. The black dashed,0.0
"individual galaxies, picking broader bins reduces these artifacts                 curve shows the spectroscopic redshift distribution. The red contour shows",0.0
"(see e.g. Kuusela 2016). Considering our toy model in Eq. (10), we                the result of the ‚ÄòMerging Bin‚Äô regularization with 30 bins applied to the",0.0
"see that if ùêæ ft (ùë°ùëè) is narrower than ùëù ftùúñ (ùë°), there can be values of ùë°        ‚ÄòFiducial‚Äô contours that are binned using 50 bins. We refer for a detailed",0.0
"where their ratio, and therefore the integrand in Eq. (10), can become            explanation to ¬ß 8 and Fig. 7, which shows and discusses the ‚ÄòFiducial‚Äô case",0.0
                                                                                  as ‚ÄòSmall Sample (50k)‚Äô.,82.0
"large or even unbounded. Subject to the aforementioned limitations,",0.0
this behaviour generalizes to the deconvolution problem considered,0.0
"here. In the following, we will denote this scheme as the ‚ÄòWide                   absolute values) in its inverse. As a regularization, one can add a",0.0
"Bin‚Äô method. As will be seen in the following section, this simple                penalty term and reformulate the problem as a minimization",0.0
scheme can lead to posteriors that can be biased and too narrow. We                   n                             o,0.0
"therefore consider alternative approaches.                                        min ||Haùëñ ‚àí 1ùëñ || 22 + ||ùöºaùëñ || 22 ,                           (18)",0.0
                                                                                  where ùëñ denotes column ùëñ of the inverse hessian and the unit matrix,82.0
"                                                                                  respectively. The matrix ùöº = ùõº1 is the Tikhonov matrix, ùõº the",82.0
4.2.1    Merging Bin Regularization                                               regularization parameter and 1 the unit matrix. The regularization,0.0
"The ‚ÄòMerging Bin Regularization‚Äô scheme (Kuusela 2016) uses a                     term penalizes large values for ai , which regularizes the inversion",0.0
very thin initial histogram binning. This will likely result in the               and reduces the condition number. The analytic solution to this,0.0
"aforementioned typical instabilities of inverse problems, but can                 minimization problem is given as:",0.0
avoid biases of the Wide-Bin regularization (or other smoothing)                                     ‚àí1,0.0
"schemes. However, we must ensure that the optimization of the                     cùëñ = HT H + ùöºT ùöº        HT 1i .                                 (19)",0.0
maximum-likelihood solution converges to a global maximum. We                           We note that we introduce the Tikhonov regularization here,0.0
therefore run multiple optimizations with different initial conditions            predominantly as a way to regularize the matrix inversion of the,0.0
"and pick the best solution. Furthermore, the hessian H can have a                 hessian. We recommend selecting the parameter ùõº to be just as large",0.0
very high condition number. Even though it is possible to sam-                    as necessary to perform this inversion accurately. Tikhonov regular-,0.0
ple from the resulting posteriors without the matrix inverse using                ization can be used as the main regularization in inverse problems;,0.0
"MCMC sampling (only the inverse covariance enters the ùúí2 ), sam-                  however, we find that the merging bin regularization scheme per-",0.0
pling is more efficient using the standard Box-Mueller method (Box                forms much better in terms of producing well-calibrated probability,0.0
"& Muller 1958), which requires an inverse.                                        nB posteriors. We reiterate that the idea of the merging bin reg-",0.0
                                                                                  ularization scheme proposed by Kuusela (2016) is to deliberately,82.0
Tikhonov Regularization We perform the matrix inversion of the                    start with histogram bins that are too small and lead to a noisy de-,0.0
"hessian H using Tikhonov regularization (see e.g. Kress 1998, pp.                 convolved density. We then exploit the characteristic noise pattern",0.0
"86-90). Here, we treat the matrix inversion as a system of linear                 in the deconvolved distribution, where bins that overshoot, i.e. are",0.0
"equations constructed from the hessian and the column-wise inverse                larger than the true value, are immediately followed by those that",0.0
hessian/unit matrix respectively. The instability of the problem can              undershoot. This results in an alternating or ‚Äòzig-zag‚Äô pattern of the,0.0
lead to very small entries in the hessian that imply large entries (in            deconvolved density. Merging these neighboring bins then helps to,0.0
                                                                                  ‚Äòstabilize‚Äô the deconvolved distribution. We therefore sample from,82.0
                                                                                  a posterior obtained assuming a finely binned histogram and merge,82.0
"8                                                                                 neighboring bins, which compensates the noise effect. We can then",0.0
"   In our case we note that all parameter values ùùÖ ‚àà Œî are bounded, because",3.0
Œî (with a chosen metric) is a bounded metric space. However these solutions       in principle directly use these samples in the cross-correlation like-,0.0
"in logit space (see ¬ß B) do not have to be bounded.                               lihood. Nonetheless, it is computationally more efficient to remap",0.0
9 We will use the term ‚Äòregularization‚Äô not only in the context of Bayesian       these samples to a regular grid with the same or very similar resolu-,0.0
"statistics, where it‚Äôs often implemented in the form of a prior, but in general   tion than the binning used for the cross-correlations, since treating",0.0
to describe methods that restrict the complexity of parameters or functions.      the finely binned histogram heights as free parameters would not,0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,22.63888888888889
8,0.0
"add more information due to the resolution loss. We found that the        normal distribution, we finally reparametrize our model on the final",0.0
template fitting posterior after merging bin regularization can again     redshift grid.,0.0
be well-described by a logit normal distribution that we fit using              The merging process described above is largely based on in-,0.0
Assumed Density filtering.                                                specting when the instabilities vanish. There are certainly more,0.0
"                                                                          principled alternatives. In a classical deconvolution problem, like",74.0
"Assumed Density Filtering To fit the logit normal distribution to         the one presented in ¬ß 3, one could use a bootstrap estimate of the",0.0
"the sampled and merged posterior samples, we work in logit space          bias and variance of the reconstruction with respect to the over-",0.0
and make a gaussian ansatz                                                smoothed photometric redshift distribution. This is consistent with,0.0
                                                                          the approach taken by Padmanabhan et al. (2005) based on the rec-,74.0
"ùëû(y) = N (y| ùùÅ, ùö∫) .                                                (20)  ommendation in Craig & Brown (1986). We use a joint likelihood",0.0
                                                                          between the photometry and spatial information to produce posteri-,74.0
We can directly generate samples from the true distribution by,0.0
                                                                          ors for the photometric sample redshift distribution and not a ‚Äòpoint,74.0
"sampling from the original, finely binned, logit-normal distribution",0.0
                                                                          prediction‚Äô. Furthermore our ‚Äòmeasured data‚Äô is the photometry and,74.0
"with subsequent merging, i.e. averaging, of neighboring bins, and",0.0
"                                                                          spatial information of galaxies. Accordingly our model selection, of",74.0
then transforming back to logit space. We will denote this true,0.0
"                                                                          which regularization is a part, must reproduce the measured pho-",74.0
distribution as ùëù true (y). Assumed density filtering then commences,0.0
"                                                                          tometry and spatial distribution, e.g., measured by the correlation",74.0
by minimizing the Kullback-Leibler divergence between our ansatz,0.0
"                                                                          functions of galaxies. In the Bayesian context, this would trans-",74.0
"ùëû(y) and ùëù(y),",0.0
              ‚à´                                                           late into the usage of posterior predictive checks (PPC) discussed,14.0
                                                                          in ¬ß 7.1. While the path to development of a more principled se-,74.0
KL( ùëù||ùëû) =      dy ( ùëù(y) log ùëù(y) ‚àí ùëù(y) log ùëû(y)) .              (21),0.0
"                                                                          lection of the hyperparameters of regularization is known, it will",74.0
"                                                                          require a thorough investigation. We defer this to future work, us-",74.0
"After optimizing ùêæ ùêø( ùëù||ùëû) for ùùÅ and ùö∫, we can show that the",0.0
                                                                          ing the aforementioned ‚Äòrule-of-thumb‚Äô methodology as an interim,74.0
optimium is reached if,0.0
‚à´                                                                         solution.,0.0
"    dy ùëù(y) y = ùùÅ ,                                                 (22)",4.0
and                                                                       5   CLUSTERING LIKELIHOOD,0.0
      ‚à´,6.0
                                    T,36.0
ùö∫=        dy ùëù(y) (y ‚àí ùùÅ) (y ‚àí ùùÅ)                                   (23)  In order to include information about the spatial distribution of,0.0
"                                                                          galaxies into the likelihood, we consider spatial cross-correlations",74.0
We see that assumed density filtering reduces to moment matching          between photometric and spectroscopic samples. Spatial correla-,0.0
"in logit space, when we apply the sample mean and sample covari-          tions measure the excess probability over random to find two galax-",0.0
ance estimators to samples from ùëù true (y). We note that this is in       ies separated by a certain distance. This can be exploited to extract,0.0
"general true for distributions of the exponential family (see, e.g.,      redshift information for galaxy samples (see e.g. Newman 2008;",0.0
Ranganathan 2004).                                                        M√©nard et al. 2013; McQuinn & White 2013; Scottez et al. 2016;,0.0
"      To summarize, we perform the inference scheme described in          Raccanelli et al. 2017; Morrison et al. 2017; Davis et al. 2017; Gatti",6.0
the previous section using a fine histogram binning. Subsequently         et al. 2018) for which we do not have accurate redshift informa-,0.0
"we sample from the posterior after regularizing the inverse hessian       tion, i.e. photometric galaxy samples, using spatially overlapping",0.0
using Tikhonov regularization. We merge neighboring bins from             spectroscopic catalogs.,0.0
each posterior draw until the noise is reduced and we obtain a smooth           The idea is to select the spectroscopic samples in thin redshift,0.0
"probability distribution. We illustrate this process in Fig. 2, which     slices and estimate the cross-correlation between these redshift-",0.0
illustrates the impact of the ‚ÄòMerging Bin‚Äô regularization scheme         selected samples and the full photometric galaxy sample. As dis-,0.0
"on the posterior of the sample photometric redshift distribution.         cussed in the following, the resulting signal will then be proportional",0.0
Comparing the grey contours (‚ÄòFiducial‚Äô) that uses 50 bins with           to the photometric redshift distribution at that redshift.,0.0
the red contours (‚ÄòMerging Bin‚Äô) that merges neighboring bins to                Fig. 3 illustrates the basic idea of cross-correlation redshift,0.0
"a binning of 30 bins, we see the much smoother shape and the              inference. We consider two galaxy samples: a reference sample",0.0
elimination of the ‚Äòzig-zag‚Äô pattern present in the grey contours.        ‚ÄòR‚Äô and a base galaxy sample ‚ÄòB‚Äô. The reference sample contains,0.0
"We defer a more thorough explanation of the methodology and               galaxies with accurate, often spectroscopic, redshift measurements;",0.0
"sample to ¬ß 8 and Fig. 7, which discusses the result shown in the         the base galaxy sample consists of galaxies observed in broad band",0.0
grey contours under the abbreviation ‚ÄòSmall Sample (50k)‚Äô.                photometric filters. As the base/reference samples are typically pho-,0.0
"      Based on our experience we propose to initially merge neigh-        tometric/spectroscopic samples, we use these terms interchangably",6.0
boring bins until we obtain a bin size of the order of the average        in text10 . The redshift distribution of the base sample is illustrated,0.0
"¬±2ùúé range of the individual galaxy redshift distributions. Subse-         by the red distribution, while the binned reference sample redshift",0.0
quently we merge fewer bins until the aforementioned character-           distributions for simplicity are shown as tophat functions (unlike,0.0
istic ‚Äòzig-zag‚Äô noise pattern appears. This can be identified as the      the simulated samples we use to test our methodology). A sin-,0.0
limiting resolution we can obtain. We note that it is important to        gle cross-correlation is then obtained by cross-correlating a single,0.0
distinguish patterns due to ‚Äòreal‚Äô line of sight structure and due to     tophat selection with the full base sample. Multiple measurements,0.0
the aforementioned noise in the deconvolution. If the pattern ap-,0.0
"pears gradually with increasing resolution (merging fewer bins),",0.0
"it is indicative of statistically significant line-of-sight structure. If 10  We note, however, that the reference sample does not have to be a spectro-",0.0
"the deconvolved density suddenly becomes unstable in a ‚Äòzig-zag‚Äô          scopic dataset, as multi-band, narrow filter photometric observations (Alar-",0.0
"pattern when fewer bins are merged, we have reached a resolution          con et al. 2020a), or photometric redshifts of redMaGiC samples (see e.g.",0.0
"limit. Using assumed density filtering under the ansatz of a logit        Gatti et al. 2018), also allow for reasonable redshift accuracy.",0.0
"                                                                                                                            MNRAS 000, 1‚Äì22 (2015)",124.0
avr_spaces,16.426666666666666
                                                                                        Likelihood Inference under Photo-z error                                   9,88.0
                                                                                 surements (wÃÇRB and wÃÇRR ) just described are assumed to individu-,81.0
                                                                                 ally follow a Gaussian likelihood11 .,81.0
                                                                                        Based on these definitions and approximations and the consid-,88.0
"                                                                                 erations in the previous section, we construct a likelihood based on",81.0
                                                                                 the ratio between wÃÇRB and wÃÇRR . Under the assumption of a diag-,81.0
"                                                                                 onal covariance matrix12 for wÃÇRB and wÃÇRR , we can construct the",81.0
                                                                                 random variable ùö™ for bin ùëñ with components,81.0
                                                                                                         !,105.0
                                                                                   meas,83.0
                                                                                                ùë§ÀÜ ùëñùëÖùêµ,96.0
                                                                                 Œìùëñ       =                 .                                                    (26),81.0
                                                                                                ùë§ÀÜ ùëñùëÖùëÖ,96.0
                                                                                 We reiterate that both ùë§ÀÜ ùëñùëÖùêµ and ùë§ÀÜ ùëñùëÖùëÖ are described by a Gaus-,81.0
                                                                                 sian Likelihood. Their respective means and standard deviations,81.0
"Figure 3. Illustration of the construction of the cross-correlation data vector. are given as ùúáRB,i , ùúáRR,i , ùúéRB,i , ùúéRR,i respectively. The theoretical",0.0
A ‚ÄòReference Sample‚Äô that can be precisely selected in redshift is moved over    prediction for the transformed random variable Œìmeas              ùëñ     is then,0.0
"a ‚ÄòBase Sample‚Äô, which can either be a sample without redshift information",0.0
(photometric sample) or the ‚ÄòReference Sample‚Äô itself. In this illustration                                              ùëè ùëñùêµ ùúãùëñùêµ,0.0
"10 cross-correlations would be estimated, constituting the cross-correlation",0.0
                                                                                 Œìtheo,81.0
                                                                                   ùëñ    (ùëè ùêµ ùëÖ ùêµ ùëÖ,83.0
"                                                                                           ùëñ  , ùëè ùëñ  , ùúã ùëñ  , ùúã ùëñ  )  =            ,                             (27)",91.0
                                                                                                                         ùëè ùëñùëÖ ùúãùëñùëÖ,121.0
data vector.,0.0
                                                                                 and its likelihood:,81.0
                                                                                                              ùëè(Œìtheo,110.0
                                                                                                                   ùëñ )ùëë (Œìùëñ ),115.0
                                                                                                                               theo,127.0
                                                                                                                                              1,142.0
"therefore ‚Äòslice‚Äô through the redshift distribution of the base sample,          ùëù(Œìmeas",0.0
                                                                                      ùëñ      |Œìtheo,86.0
                                                                                                 ùëñ ) =                                 ‚àö               √ó,97.0
illustrated here by the arrows and the grey hatched tophat slices.                                                 ùëé 3 (Œìtheo,0.0
"                                                                                                                          ùëñ )            2ùúãùúéRB,i ùúéRR,i",122.0
                                                                                                       !                         !!,103.0
"      As described in detail in Schmidt et al. (2013), Morrison et al.                   ùëè(Œìtheo",6.0
                                                                                              ùëñ )                     ùëè(Œìtheo,94.0
                                                                                                                            ùëñ ),124.0
"(2017) and M√©nard et al. (2013), we measure the over-density, com-                 Œ¶                     ‚àíŒ¶ ‚àí                                                    (28)",0.0
                                                                                         ùëé(Œìtheo,89.0
                                                                                              ùëñ )                     ùëé(Œìtheo,94.0
                                                                                                                            ùëñ ),124.0
"pared with a spatially random distribution of points, of photometric                                                                      !",0.0
"galaxies around each galaxy in the spectroscopic sample, within                                      1                                ùëê",0.0
"an annulus of physical scale Œîùúí = [ ùúímin , ùúímax ]. The theoretical                +                                      exp ‚àí theo .",0.0
                                                                                     ùëé 2 (Œìtheo,85.0
"                                                                                            ùëñ )ùúãùúéRB,i ùúéRR,i                       Œìùëñ",92.0
model for a cross-correlation function between the spectroscopic,0.0
reference sample in tophat bin ùëñ and the photometric base sample is              Here Œ¶(ùëß) denotes the cumulative distribution function of the zero,0.0
given as:                                                                        mean unit variance normal distribution and,0.0
                               !                                                                  ‚àöÔ∏Ñ,31.0
                       ùúãùëñB                                                       ùëé(Œìtheo,23.0
                                                                                                          1,106.0
                                                                                                                (Œìtheo,112.0
                                                                                                                                   1,131.0
                                                                                           )  =                     ùëñ ) + 2,91.0
   RB     ùëÖ ùêµ                                                                                                             2                                      (29),3.0
"ùë§ùëñ ‚àù ùëèùëñ ùëèùëñ                       ùë§ DM,i .                                  (24)       ùëñ                  2",0.0
"                                                                                                      ùúéRB,i                     ùúéRR,i",102.0
                   ùëß ùëñùêª ‚àí ùëßùëñùêø,19.0
"                                                                                                   ùúáRB,i             ùúáRR,i",99.0
                                                                                 ùëè(Œìtheo,81.0
                                                                                      ùëñ ) = 2               Œìùëñ + 2                                               (30),86.0
"Here, ùëè ùëñùëÖ and ùëè ùëñùêµ denote the value of the redshift-dependent galaxy-                            ùúéRB,i              ùúéRR,i",0.0
dark matter bias of the reference (R) and base (B) samples. The                                                                             !,0.0
"normed histogram bin heights of the base, or photometric, sample                      theo",0.0
                                                                                                           ùëè(Œìtheo      2,107.0
                                                                                                                  ùëñ ) ‚àí ùëêùëé(Œìùëñ ),114.0
                                                                                                                                     theo 2,133.0
                                                         √ç                       ùëë (Œìùëñ ) = exp                                                                   (31),57.0
"redshift distribution are denoted as ùúãùëñùêµ , where ùëñ ùúãùëñùêµ = 1, and the                                                  2ùëé(Œìtheoùëñ )",0.0
                                                                                                                                  2,130.0
"size of a redshift bin is given as ùëß ùëñùêª ‚àí ùëß ùëñùêø . The term ùë§ DM,i denotes                             2             2",0.0
"                                                                                                   ùúáRB,i         ùúáRR,i",99.0
the contribution of dark-matter clustering to the cross-correlation                        ùëê=                 +           .                                      (32),0.0
"signal, which depends on the cosmological model.                                                     2",0.0
"                                                                                                  ùúéRB,i             2",98.0
"                                                                                                                 ùúéRR,i",113.0
      We see that the modelling of the cross-correlation signal de-,6.0
"pends on the product of two redshift-dependent galaxy-dark matter                For the following discussion we define n = ùëßùêª ùùÖ‚àíùëß ùêø , i.e. the variables",0.0
"bias functions that are completely degenerate with the set of pa-                ùùÖ, n refer to histogram heights normalized to sum to unity and to",0.0
rameters ùúã B that parametrizes the redshift distribution of the base             unit area respectively. The variable nB and nR refer to the histogram,0.0
"sample. Furthermore, since ùë§ DM,i depends on the cosmological                    heights of the base and reference samples. This likelihood assumes",0.0
"model, it will be computationally expensive to sample over these                 independence between neighboring redshift bins. We can, however,",0.0
parameters.                                                                      expect a degree of correlation especially for lower redshift bins due,0.0
"      To reduce the impact of the cosmological model, we want to                 to magnification effects.",6.0
combine the cross-correlations wRB with the correlations wRR of                         Eq. (28) is approximately independent of the modelling of the,0.0
"the spectroscopic sample. We therefore correlate the spectroscopic               ùë§ DM term, assuming that we pick sufficiently thin redshift bins to",0.0
"sample with itself in a manner analogous to what was just described,             ‚Äòdivide-out‚Äô the redshift-dependence of the dark matter clustering",0.0
"i.e., by correlating tophat selected spectroscopic samples with the              term ùë§ DM . Based on the aforementioned independence assumption",0.0
full spectroscopic sample. The corresponding theory prediction then,0.0
reads,0.0
"                               !                                                 11  In reality, we expect that the likelihood will deviate from the Gaussian",31.0
   RR       ùëÖ 2,3.0
                       ùúãùëñùëÖ,23.0
"ùë§ ùëñ ‚àù (ùëè ùëñ )                     ùë§ DM,i                                    (25)  assumption (see e.g. Hahn et al. 2019).",0.0
"                   ùëß ùëñùêª ‚àí ùëß ùëñùêø                                                   12 While the covariance matrix will be dominated by the diagonal, we",19.0
"                                                                                 can expect, that the cross-correlation measurements in different bins will",81.0
where ùúãùëñùëÖ is the normalized histogram height of the spectroscopic                be correlated. Thus the assumption of a diagonal covariance matrix is an,0.0
(full) sample redshift distribution. Both correlation function mea-              approximation.,0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,51.029126213592235
10,0.0
"between redshift bins, the joint likelihood for all bins ùëñ now reads:       7.1    Model Evaluation: Posterior Predictive Checks",0.0
                             ùëÅ,29.0
                             √ñbins                                          The idea of posterior predictive checks (PPC) is to simulate syn-,29.0
"ùëù(ùö™|bb , bR , nR , nB ) =          ùëù(Œìùëñ |ùëè ùëñùêµ , ùëè ùëñùëÖ , ùëõùëñùëÖ , ùëõùëñùêµ )     (33) thetic data from a fitted model, that is then compared with the",0.0
                             ùëñ=1                                            original measurements to serve as an internal consistency check.,29.0
                                                                            For example there exist several approaches that allow us to estimate,76.0
The function that describes the set of ratios ùëè ùëñùêµ /ùëè ùëñùëÖ will be denoted    the quality of probability calibration based on the distribution of,0.0
"as ùê∂ (ùëß, Œîùúí‚ä• ) and depends both on redshift and the size of the             posterior predictive ùëù-values (e.g. Gelman et al. 1996). This paper",0.0
"annulus Œîùúí. For a selected annulus size we will use the abbreviation        will only provide a short discussion of posterior predictive testing,",0.0
ùê∂ (ùëß).                                                                      which is still an area of active research. The basic idea of model,0.0
                                                                            checking is to investigate if data predicted by the fitted model is,76.0
"                                                                            representative of the observed data. The classical approach, for ex-",76.0
"                                                                            ample developed for linear regression, uses an analytical probability",76.0
6    THE COMPOSITE LIKELIHOOD                                               distribution for the test statistic (for example the ùúí2 distribution) and,0.0
                                                                            evaluates the tail probability to test how much of an ‚Äòoutlier‚Äô the,76.0
"To formulate a joint likelihood for the data vector of both galaxy po-      observed data is, given the fitted model. This approach can be prob-",0.0
"sitions and photometry, we use the composite likelihood ansatz (e.g.        lematic if the model is complex13 , which makes it difficult to derive",0.0
Varin et al. 2011) that uses the product of marginal likelihoods for        an analytic sampling distribution for a suitable statistic given a fitted,0.0
both the photometry FÃÇ and the vector of cross-correlation functions        model. Further problems arise due to significant influence of out-,0.0
"ùö™:                                                                          liers, or if parameters are subject to boundary conditions. Posterior",0.0
                                                                            predictive checks are extensions to this classical approach in the,76.0
"ùëù( FÃÇ, ùö™|nB,sys , nB , nR , C(z)) = ùëù( FÃÇ|n ùêµ ) ùúê1 ùëù(ùö™|nB,sys , C(z)) ùúê2 ,  Bayesian framework.",0.0
"                                                                       (34)       Starting from the composite likelihood defined in Eq. (34), the",71.0
                                                                            posterior predictive distribution reads,76.0
where ùùä are weights that can be selected to improve the efficiency of,0.0
                                                                                             ‚à¨,93.0
the estimation (see e.g. Varin et al. 2011) by increasing the influence,0.0
"of one part of the composite likelihood over the other. Furthermore         ùëù(Drep |D) =         dnB dC(z) ùëù(D rep |nB , C(z)) ùëù(nB , C(z)|D) ,",0.0
the composite likelihood can be conditioned on auxiliary parameters                                                                               (35),0.0
such as the field. For simplicity we consider here only the simple,0.0
"case of ùùä = 1 and refer for an additional discussion to ¬ß 10.               where D = {Œì(ùë§ BR , ùë§ RR ), FÃÇ} and D rep denote the replicated, or",0.0
"       We note that measurements of LSS and weak lensing often              predicted, measurements sampled from the fitted model. We note",7.0
"use galaxy samples that are selected by increasing redshift, to form        that our model specifies only the ratio between ùë§ RB and ùë§ RR . How-",0.0
"tomographic bins. This analysis methodology can be incorporated             ever, we can always sample replications for one of these quantities",0.0
into Eq. (34) by replacing FÃÇ and ùö™ with the joint data vectors of the      using the measurement of the other via the data transformation,0.0
"selected galaxy samples, which would include covariances between            specified in Eq. (26).",0.0
the ùö™ measurements for different tomographic bins. Furthermore                    Posterior predictive checking is particularly useful as it allows,0.0
the quality and number of available photometric bands can change            us to access model calibration quality and predictive accuracy with-,0.0
for different spatial areas. Similarly we need to construct a joint data    out spectroscopic (or accurate multiband photometric) validation,0.0
vector of FÃÇ and ùö™ that incorporates these covariances. This can be         data. This is a decisive advantage of specifying the photometric,0.0
modelled either analytically (e.g. Stoyan & Stoyan 1994; S√°nchez            likelihood over empirical approaches based on machine learning,0.0
"et al. 2020) or by using spatial resampling techniques. In this work        or, more specifically, conditional density estimation. By modelling",0.0
"we will concentrate on the composite likelihood as given in Eq. (34)        the data generating process of SED evolution and redshifting, we",0.0
"and refer extensions of the method to future work.                          can generate new photometry using a fitted physical model, giving",0.0
                                                                            us the opportunity to develop statistical tests based on the predic-,76.0
                                                                            tive distribution to probe the quality of the photometric likelihood,76.0
                                                                            calibration.,76.0
"                                                                                  To avoid confusion, it is important to clarify that posterior",82.0
7    MODEL EVALUATION AND PARAMETRIZATION OF,0.0
"                                                                            predictive checking and model comparison, while often method-",76.0
     SYSTEMATICS,5.0
"                                                                            ologically similar, have different goals. Posterior predictive checks",76.0
Parameter inference is only a single step in a full statistical analysis    aim to provide internal consistency tests for a given model and in-,0.0
and needs to be combined with additional analysis steps. We need            ference framework. Model comparison/combination has the goal to,0.0
to ensure that parameters can be uniquely inferred and the posterior        compare/combine multiple models based on some measure of fitting,0.0
"does not exhibit flat regions or strong degeneracies, which can make        accuracy. However, model comparison and combination can also be",0.0
the application of MCMC techniques difficult (see e.g. Rothenberg           based on posterior predictive accuracy (see e.g. Gelman et al. 2013).,0.0
"1971; Raue et al. 2013). Furthermore, one needs to investigate the          In the development of new models and the evaluation of directions",0.0
"sensitivity of the results against changes in the prior and likelihood.     for improvement, both of these concepts work together.",0.0
"Finally, one has to judge if the inferred posteriors are sensible in              An important prerequisite for the fitting of complex statis-",0.0
the context of the cosmological/astrophysical model and evaluate if         tical models is the evaluation of model parameter degeneracies.,0.0
the fitted model is a good representation of the observed data. The         We have discussed the fact that the parameters that describe the,0.0
last step will be the topic of this section. ¬ß 7.1 describes posterior,0.0
predictive checks as a means to evaluate the goodness of fit of the,0.0
model and in ¬ß 7.2 we propose a method to parametrize systematics           13  An example are models that do not have the form of a generalized linear,0.0
"due to biased photometric likelihoods.                                      model (see, e.g., Gelman et al. 1996).",0.0
"                                                                                                                            MNRAS 000, 1‚Äì22 (2015)",124.0
avr_spaces,20.014492753623188
                                                                                   Likelihood Inference under Photo-z error                            11,83.0
redshift-dependent galaxy-dark matter bias and the sample redshift,0.0
distribution enter the clustering likelihood in a completely degener-,0.0
"ate way. Accordingly, completely different nB -C(z) combinations                                                                         nR",0.0
will produce the same data distribution. This therefore limits the,0.0
information that can be obtained on nB depending on the prior in-,0.0
"formation imposed on C(z). A combination with the photometric                              FÃÇ          z         nB        nB,sys         Œì",0.0
"likelihood can help to break these degeneracies, as long as the SED",0.0
"modelling itself does not exhibit strong degeneracies, e.g. between                     NFilter                                               Nz‚àíhist",0.0
the SED type and the redshift of galaxies. A dedicated study of,0.0
model checking in color space is left for future work.                                 NGalaxy,0.0
                                                                                                                             œÑ          C(z),125.0
                                                                                                                                                 Ntomo,145.0
7.2    Parametrizing Systematics: Smoothing Kernel,0.0
"In ¬ß8.3, we will discuss how miscalibrated likelihoods can lead to             Figure 4. Directed graphical representation of the statistical model de-",0.0
systematic biases and uncertainties in the deconvolution operation.            scribed in this paper. Empty/filled circles denote random variables that,0.0
Our goal in this section is to include a simple transformation into the        are latent/observed. ùëÅ (‚àó) denotes the dimensionality of the random vari-,0.0
model that parametrizes these systematics. A simple choice is the              able. Boxes encapsulate random variables with the same dimensionality.,0.0
"Gaussian convolution kernel, which modifies the sample redshift                Solid/dotted lines indicate random/deterministic relationships between ran-",0.0
                                                                               dom variables.,79.0
distribution as,0.0
                ‚à´             ‚à´,16.0
"ùëù(ùëß|nB,sys ) =      dùùâ ùëù(ùùâ)        ùëù(ùëß|ùëß, ùùâ) ùëù(ùëß|nB ) dùëß .           (36)      sizes Œîùúéùëñ and Œîùúá = 0",0.0
                                                                                                        ‚àëÔ∏Å,104.0
" Here nB,sys denotes the parameters that describe the sample red-              ùëù(nz ùêµ , C(z)|ùö™, FÃÇ) =        ùëù(Œîùúéùëñ |ùö™, FÃÇ) ùëù(nzB , C(z)|ùö™, FÃÇ, Œîùúéùëñ ) .",1.0
shift distribution after the convolution is applied to the original                                     Œîùúéùëñ,0.0
"sample redshift distribution ùëù(ùëß|nB ), where the convolution ker-                                                                                    (39)",0.0
nel is a gaussian with standard deviation and shift in the mean,0.0
                                                                               This assumes that there is no systematic shift in the sample redshift,79.0
"ùùâ = (Œîùúá, Œîùúé):",0.0
"                                                                               distribution, and deviations from the true underlying distribution are",79.0
"                                 ""                    #                       due to miscalibrated but on average unbiased individual galaxy like-",33.0
                                     1 ùëß ‚àí ùëß + Œîùúá 2,37.0
                                       ,39.0
                   1,19.0
"ùëù(ùëß|ùëß, ùùâ) = ‚àöÔ∏É              exp ‚àí                                    (37)      lihoods. Furthermore, we will assume that ùëù(Œîùúéùëñ |ùö™, FÃÇ) = ùëù(Œîùúéùëñ ),",0.0
                                     2       Œîùúé,37.0
"                (2ùúãŒîùúé) 2                                                       i.e., the smoothing size is a prior choice independent of the data that",16.0
                                                                               can be calibrated on simulations. For simplicity we will use a flat,79.0
 Assuming the same histogram parametrization for ùëù(ùëß|nB ) as for               prior ùëù(Œîùúé) here.,1.0
"ùëù(ùëß|nB,sys ), we see that this implies an affine transformation nB ‚Üí   ‚àí",0.0
A(ùúè) ¬∑ nB where the matrix A is given as,0.0
                                                                               7.3     Complete model summary,79.0
                  ùõΩ     ùõΩ               !             ùõΩ     ùõΩ          !,18.0
              ùëó  ùëßùêª  ‚àí ùëßùêø                        ùëó ùëß     ‚àí ùëßùêø                  Here we review and summarize our complete model. We review,14.0
"ùê¥ùõΩ ùëó = Œ¶ ùëß ùêª                + Œîùúá, Œîùúé ‚àí Œ¶        ùëßùêø ùêª          + Œîùúá, Œîùúé         the structure of all components in ¬ß 7.3.1 and review the inference",0.0
                     2                                   2,21.0
                                                          ùõΩ ùõΩ              strategy in ¬ß 7.3.2.,24.0
                            ùõΩ    ùõΩ,28.0
                   ùëó      ùëß ùêª ‚àíùëß ùêø                     ùëó    ùëß ‚àíùëß,19.0
            ¬© ¬© ùëßùêª    ‚àí       2      ‚àí Œîùúá  ¬™       ¬© ùëß ‚àí ùêª 2 ùêø ‚àí Œîùúá ¬™¬™,12.0
         1 ¬≠¬≠ ¬≠¬≠                           ¬Æ       ¬≠ ùêø                    ¬Æ¬Æ,9.0
"      = ¬≠erf ¬≠                 ‚àö           ¬Æ ‚àí erf ¬≠           ‚àö          ¬Æ¬Æ , 7.3.1     Model Structure",6.0
         2¬≠ ¬≠             Œîùúé 2                              Œîùúé 2,9.0
                                           ¬Æ       ¬≠                      ¬Æ¬Æ,43.0
                                           ¬Æ       ¬≠                      ¬Æ¬Æ,43.0
            ¬´ ¬´                            ¬¨       ¬´                      ¬¨¬¨   Fig. 4 summarizes the joint inference strategy presented in the previ-,12.0
                                                                     (38)      ous sections in a directed graphical model. Each random variable is,69.0
"                                                                               denoted as a circle, probabilistic/deterministic relationships are de-",79.0
where Œ¶ denotes the cumulative distribution function of a nor-                 noted as solid/dotted lines. Boxes around random variables denote,0.0
mal distribution and erf the error function. We choose a Gaussian              the dimensionality of the random variable. For example the color,0.0
smoothing kernel since it has been shown that unbiased cosmologi-              vector fùëñ is an ùëÅfilter dimensional random variable for ùëÅgalaxies in,0.0
cal inference from measurements of weak lensing and LSS critically             ùëÅtomo tomographic bins. Filled circles denote observed random,0.0
"depends on accurate recovery on the mean and standard deviation of             variables, in our case the photometry FÃÇ and the cross correlation",0.0
the photometric sample redshift distribution. Biases in both of these          ratios ùö™.,0.0
statistics can be parametrized using this kernel. In contrast to the                  The graphical model is structured into three parts: the left,0.0
"normal distribution, which exhibits a closed form solution under an            part represents the photometric likelihood, the middle bullets de-",0.0
"affine transformation, the logit-normal does not have this property.           scribe our treatment of systematics, and the right part describes the",0.0
"However we empirically find that we can approximate the shape                  clustering redshift likelihood, which depends on the spectroscopic",0.0
of the distribution after an affine transformation as a logit-normal           redshift distribution and the redshift-dependent galaxy-dark matter,0.0
"distribution to good accuracy. For a given set of ùùâ, we can find the           bias ratio.",0.0
updated parameter values by assumed density filtering.                                The structure of the graph illustrates the construction of the,0.0
"      While marginalization using sampling techniques is possible,             model via the composite likelihood ansatz discussed in ¬ß 6. It sep-",6.0
we choose a computationally efficient approximation and marginal-              arates the two data sources FÃÇ and ùö™ in the left and right part of,0.0
ize over a discrete model set that consists of different smoothing             the graph. As we are mainly interested in performing inferences on,0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,19.0
12,0.0
"the nB variables, we marginalize over the ùëß variables, which pro-",0.0
vides significant computational advantages. The mapping between,0.0
"nB and nB,sys takes the form of a deterministic transformation and",0.0
is therefore indicated by a dotted line.,0.0
"      While n ùëÖ is here treated as a random variable, its ‚Äòshot noise‚Äô",6.0
uncertainties are very small for the considered sample sizes of the,0.0
spectroscopic sample. We therefore decided to fix its value to the,0.0
"maximum likelihood value, i.e., the histogram height.",0.0
7.3.2    Model Inference,0.0
The presented model consists of two likelihood terms and a de-,0.0
"terministic transformation nB ‚Üí nB,sys . Starting with the pho-",0.0
"tometric likelihood, we employ the inference scheme detailed in",0.0
Appendices A and B that results in a posterior ùëù(nB | FÃÇ) de-,0.0
fined in Eq. (16). We then employ the transformation detailed in,0.0
¬ß 7.2 to parametrize systematics in the inferred posterior from,0.0
biased photometric likelihoods. This yields a systematics cor-                Figure 5. The top three panels show cross-correlation measurements be-,0.0
"rected posterior ùëù(nB,sys | FÃÇ) using the methodology described in            tween the photometric base sample and the spectroscopic reference sample",0.0
¬ß 7.2. The final combination with the clustering likelihood term              ùë§ RB and correlation function measurements of the spectroscopic reference,0.0
"ùëù(nB,sys , C(z)| FÃÇ, ùö™) ‚àù ùëù(ùö™|nB,sys , C(z)) ùëù(nB,sys | FÃÇ) is then per-      sample ùë§ RR for 3 different annuli (see ¬ß 5) as a function of redshift. The",0.0
formed using a Monte Carlo Markov chain (MCMC) sampling ap-                   errorbars correspond to the ¬±1ùúé measurement errors of the correlation,0.0
proach.                                                                       function measurements. The lowest panel plots the true sample redshift,0.0
"      We update the parameters (nB,sys , C(z)) in two sampling                probability density function of the spectroscopic reference sample (‚ÄòSpec.‚Äô)",6.0
blocks: the set of parameters that describe the redshift distribu-            and the photometric base sample (‚ÄòPhot.‚Äô).,0.0
"tion of the base sample nB,sys and the parameters c that describe the",0.0
evolution of the redshift-dependent galaxy-dark matter bias ratio,0.0
                                                                              therefore study the impact of likelihood mis-specification on the,78.0
C(z).,0.0
                                                                              inference in ¬ß 8.3. In particular we will evaluate the performance,78.0
"      Concretely, we iteratively sample from the conditional distribu-",6.0
                                                                              of our methodology by comparing with science requirements of the,78.0
"tions ùëù(nB,sys | FÃÇ, ùö™, c) and then from ùëù(c| FÃÇ, ùö™,",0.0
"                                                  ÀÜ nB,sys ). This means",50.0
                                                                              first year (‚ÄòLSST Y1‚Äô) and the 10th year (‚ÄòLSST Y10‚Äô) of the LSST,78.0
"that we iteratively sample each parameter block in turn, while hold-",0.0
                                                                              data release defined in The LSST Dark Energy Science Collabora-,78.0
ing the other parameter block fixed. The sampling method that can,0.0
                                                                              tion et al. (2018). We note that we will utilize a mock simulation of,78.0
be employed to update each parameter blocks is flexible14 . We use a,0.0
                                                                              galaxy photometry likelihoods in ¬ß 8.2 instead of SED likelihoods,78.0
Metropolis-Hastings sampling scheme to sample the c parameters.,0.0
"                                                                              constructed on the simulated photometry, because the simulated",78.0
"To sample from the conditional ùëù(nB,sys | FÃÇ, ùö™, c) we also employ a",0.0
                                                                              photometry of the DC2 simulations showed a discontinuous color-,78.0
"Metropolis scheme, however we perform the sampling not in terms",0.0
"                                                                              redshift mapping, which induced an unrealistically large error in",78.0
"of the nB,sys parameters, but in logit space, i.e. in terms of the",0.0
"                                                                              our template fitting results. In ¬ß 8.3, which will discuss aspects",78.0
"y parameters that are connected with nB,sys , or their normalized",0.0
                                                                              of model checking and will not interpret results in the context of,78.0
"analog ùúã sys , via Eq. (B1). In this way we can utilize proposal dis-",0.0
"                                                                              LSST science requirements, we will use both Machine Learning",78.0
tributions that are defined in real space to sample a distribution,0.0
                                                                              and Template Fitting methods described in ¬ß 2.1.,78.0
"defined on the simplex. We reiterate that the posterior ùëù(nB | FÃÇ) has,",0.0
"in our framework, an analytical form and sampling is therefore very",0.0
efficient. However if we include a treatment of systematics or a              8.1    Measuring Cross-Correlations,0.0
"clustering redshift likelihood into the inference, we need to employ",0.0
sampling approaches because the posterior has no longer a closed              We use the software package ‚Äòthe-wizz‚Äô15 (Morrison et al. 2017) to,0.0
form solution.                                                                measure cross-correlations between the reference (spectroscopic),0.0
                                                                              and base (photometric) samples ùë§ RB and correlations of the refer-,78.0
"                                                                              ence sample ùë§ RR in 20 equally spaced redshift bins from ùëß ‚àà (0, 3),",78.0
                                                                              corresponding to 3042 Mpc comoving distance at the mean redshift,78.0
8    FORECAST USING SIMULATION DATA                                           of hùëßi = 0.88. Fig. 5 shows these measurements in the three top pan-,0.0
"To demonstrate the effectiveness of our inference methodology, we             els for three annuli (see ¬ß 5) of 0.01 ‚àí 0.1 Mpc, 0.1 ‚àí 1.0 Mpc and",0.0
consider an idealized setup which allows us to forecast the con-              1.0‚àí10 Mpc. In the lowest panel we show the sample redshift proba-,0.0
straints on the sample redshift distribution that we can expect from          bility density functions for the reference and base samples. The cor-,0.0
a DESI-like spectroscopic survey overlapping with the LSST Y10                relations wRR are larger than the cross-correlations wRB in all three,0.0
"footprint. We assume in this section that the composite likelihood            panels, implying on average a lower than unity ratio ùëè B (ùëß)/ùëè R (ùëß).",0.0
"is well calibrated, both in the clustering and in the template fit-           The errorbars increase with redshift due to the decreasing number",0.0
"ting part. This assumption will likely not hold in practice and we            of galaxies, leading to a larger shot noise error. Consider the shape",0.0
"                                                                              of wRR and wRB for the largest annuli [1.0 ‚àí 10.] Mpc, in the low",78.0
                                                                              redshift range of ùëß < 1.0. We see that the measurements of wRB,78.0
14  We tried several approaches like Hamiltonian MCMC or Elliptical Slice,0.0
sampling. All approaches work well; we discuss here the structurally simplest,0.0
scheme.                                                                       15  https://github.com/morriscb/the-wizz,0.0
"                                                                                                                               MNRAS 000, 1‚Äì22 (2015)",127.0
avr_spaces,21.5
                                                                                                Likelihood Inference under Photo-z error                                      13,96.0
and wRR roughly resemble the shape of the reference and base sam-                                               Galaxy-DM Bias Ratio Scale/z-Dependence (¬±1 ),0.0
"ple redshift distributions (lowest panel), implying a roughly linear                                          2.0",0.0
ratio ùëè ùêµ (ùëß)/ùëè ùëÖ (ùëß) in this redshift range (compare with Fig. 6).,0.0
"For smaller annuli, the change in slope around ùëß = 0.5 is less pro-                                           1.5",0.0
                                                                                  Bias Ratio b B(z)/b R(z),82.0
"nounced, producing a step around ùëß = 0.5 in the galaxy-dark matter",0.0
"bias ratio. At the high-redshift tail, where the redshift distribution                                        1.0     Mag-Lim LRG         ELG         QSO",0.0
"of the reference sample flattens out, we see that wRB and wRR are",0.0
"approximately equal. Here, the sample redshift distribution of the                                            0.5",0.0
base sample is larger than the one of the reference sample. Since,0.0
the QSO sample will have a larger galaxy-dark matter bias than the                                            0.0,0.0
"base sample, we can expect ùëè ùêµ (ùëß)/ùëè ùëÖ (ùëß) < 1.0 at high redshift.",0.0
In order to represent a 5000 deg2 overlap between DESI and LSST                                               0.5         0.01 0.10 Mpc,0.0
                                                                                                                          0.1 1.0 Mpc (Fiducial Choice),122.0
"Y10, using measurements obtained on the the 300 deg2 CosmoDC2                                                             1.00 10.00 Mpc",0.0
"simulations, we scale the error on these measurements by a factor                                                   0.0     0.5        1.0        1.5       2.0   2.5   3.0",0.0
of 4 in the following analyses.                                                                                                               Redshift z,0.0
      We would like to generate a cross-correlation likelihood that,6.0
allows us full control over the imposed redshift-dependent galaxy-               Figure 6. Galaxy-dark matter bias ratio as a function of redshift for different,0.0
"dark matter bias ratio model and that has roughly16 the correct                  scales. We show here the [16, 84] percentiles, that correspond to ¬±1ùúé for",0.0
"width of the full DESI area. Furthermore, since the mean of the                  a Normal distribution. The redshift ranges of the different spectroscopic",0.0
"ratio distribution depends on both the mean and the variance of                  subsamples are plotted by vertical lines. Within these ranges, the bias ratio",0.0
"wRB and wRR , scaling the measurement error will induce biases                   is a relatively smooth function of redshift, indicating a smooth redshift",0.0
in the mean of this ratio and therefore in the reconstructed sample              dependence of the galaxy-dark matter bias of the photometric sample. At,0.0
"                                                                                 the borders of these ranges, the bias ratio curves are discontinuous.",81.0
photometric redshift distribution.,0.0
      To correct for possible biases that would occur when the mea-,6.0
surements errors are naively scaled and allow for better control over            Furthermore we want to have control over the underlying redshift,0.0
"the redshift dependent galaxy-dark matter bias ratio, we first fit the           dependent galaxy-dark matter bias model to eliminate any additional",0.0
galaxy-dark matter bias ratio ùê∂ (ùëß) to the original data within these            specification error. It should therefore merely be seen as an approx-,0.0
20 bins. We show the results of this fit in Fig. 6 for different ranges          imate forecast of the constraining power that cross-correlations will,0.0
in physical distance and indicate the redshift range of the differ-              add to the composite likelihood and a demonstration of the inference,0.0
"ent spectroscopic samples by vertical lines, where these limits are              methodology. It is not an accurate treatment of galaxy-dark matter",0.0
meant to guide the eye and do not constitute sharp breaks (com-                  bias or the correlation function measurements expected in the final,0.0
"pare with Fig. 1). We see that within these redshift ranges, ùê∂ (ùëß) is a          LSST measurement. For this we would require a more realistic sim-",0.0
"smooth function and can be fitted by a 3rd degree Chebychev polyno-              ulation of the DESI-like spectroscopic sample, the final area and a",0.0
              √ç,14.0
"mial ùê∂ (ùëß) = 3ùëñ=1 ùëê ùëñ ùëáùëñ (ùëß). Here, ùëáùëñ (ùëß) denote Chebychev functions            much better understanding of the galaxy-dark matter bias of each",0.0
"and ùëê ùëñ denotes the expansion coefficients. Within the three redshift            galaxy population, all of which are subjects of active investigation",0.0
"ranges {[0.0, 0.5], [0.5, 0.8], [0.8, 3.0]}, we perform a regression             in the field.",0.0
fit to the median of the ùê∂ (ùëß) posterior due its heavy tails. For the,0.0
"following analysis we select the median annuli of 0.1‚àí1 Mpc, which",0.0
"provides good signal-to-noise, while being less sensitive to small               8.2                         Applying the Model",0.0
"scale effects, than the 0.01 ‚àí 0.1 Mpc bin, for which accurate mod-",0.0
                                                                                 For the photometric part of the composite likelihood we assume a,81.0
"elling of galaxy-dark matter bias will be more difficult. However,",0.0
"                                                                                 redshift scaling of ùúé(ùëß) = 0.02 (1 + ùëß), where ùëß denotes the true, or",81.0
"we are still considering the non-linear regime, in which more work",0.0
"                                                                                 spectroscopic, redshift. This scaling is a photometric redshift perfor-",81.0
is needed to model the galaxy-dark matter bias.,0.0
                                                                                 mance benchmark for LSST frequently adopted in the literature (e.g.,81.0
      We scale the correlation functions ùë§ ùëÖùëÖ and ùë§ ùëÖùêµ defined in,6.0
                                                                                 Graham et al. 2020) and defined in the LSST science requirements,81.0
"Eq. (26) and forecast a new data vector for ùë§ ùëÖùêµ , while holding the",0.0
                                                                                 document17 . We then generate a mock catalog by sampling values,81.0
measurement of ùë§ ùëÖùëÖ fixed. This amounts to multiplying the ratio,0.0
                                                                                 from the true sample redshift distribution and generate a catalog of,81.0
wRB /wRR by a constant for each redshift bin that compensates for,0.0
                                                                                 mock likelihoods by scattering these values within this redshift error,81.0
the difference in the mean of the reconstructed sample photometric,0.0
                                                                                 model. We reiterate that we assume here that the redshift likelihoods,81.0
redshift distribution before and after we impose the fitted redshift,0.0
"                                                                                 constructed from the galaxies‚Äô photometry, mimicked here by the",81.0
dependent galaxy-dark matter bias model and perform the scaling.,0.0
"                                                                                 aforementioned redshift error model, is perfectly known. We note",81.0
In this way we ensure that our ratio distribution is self-consistent,0.0
                                                                                 that this is an idealized assumption that we impose to demonstrate,81.0
with the photometric sample redshift distribution. We then use,0.0
                                                                                 the methodology described in the previous sections.,81.0
these adjusted measurements in the composite likelihood (Eq. 34).,0.0
                                                                                       Tab. 1 summarizes the different configurations we use in this,87.0
This correction is necessary because we would otherwise merely,0.0
                                                                                 work. In particular we investigate posteriors obtained using several,81.0
"use noisy measurements with wrongly decreased errorbars, which",0.0
"                                                                                 different sample sizes and regularization techniques. In particular,",81.0
will lead to biases in the probability calibration of any inference.,0.0
                                                                                 the first and second columns show the abbreviation used in the,81.0
                                                                                 text and the corresponding figure. The generated sample size of the,81.0
                                                                                 mock catalog is shown in the third column. The columns ‚ÄòTikhonov,81.0
16  The uncertainty in the correlation function measurements will likely,0.0
differ from this factor of four scaling in the real data. Our treatment of the,0.0
cross-correlation data vector here is approximate and will be complemented       17 https://docushare.lsst.org/docushare/dsweb/Get/LPM-17,0.0
in future work.                                                                  (page 4),0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,22.767441860465116
14,0.0
Figure 7. Left panel: Posteriors of the sample redshift probability density function ùëù (ùëß) of the photometric sample (short: photometric redshift distribution),0.0
"parametrized by the parameters nB for different setups listed in Tab. 1. The x-axis shows the redshift value ùëß, the y-axis the value of the nB parameters. The",0.0
"errorbars are the [16, 84] percentiles, which would correspond to 1ùúé intervals for a normal distribution. The black dashed curve shows the spectroscopic",0.0
"redshift distribution in the binning used by the cross-correlation measurements. We consider four cases, and refer to Tab. 1 and ¬ß 8 for details on the experimental",0.0
"setup. We highlight a variance-dominated posterior ‚ÄòSmall Sample (50k)‚Äô, which shows a characteristic alternating, or ‚Äòzig-zag‚Äô pattern, as well as a comparison",0.0
"between the cyan ‚ÄòMedium Sample (500k)‚Äô and ‚ÄòMedium Sample (500k), Fid. Setup + WX‚Äô posteriors. Here, the latter includes a cross-correlation ‚ÄòWX‚Äô data",0.0
vector in its likelihood. This reduces the error especially in the high-redshift tail of the distributions. Right panel: The y-axis shows the relative difference,0.0
between the posterior of the photometric redshift distribution parametrized by the nB                                                                     B,0.0
                                                                                          post parameters and the spectroscopic redshift distribution ntrue (black,90.0
dashed curve in the left panel).,0.0
                           Abbreviation                    Sample Size    Figure     Tikhonov Reg. ùõº        Initial Binning   Effective Binning       WX,27.0
                       Small Sample (50k)                       50k        Fig. 7             0.1                  50                  50               -,23.0
                     Medium Sample (500k)                      500k        Fig. 7            0.08                  50                  31               -,21.0
             Large Sample (5000k) Oversmoothing                5000k       Fig. 7           0.0001                 25                  25               -,13.0
"          Medium Sample (500k), Fid. Setup & WX                 500k       Fig. 7            0.08                  50                  31               X",10.0
                         Tik. Regul. Low                       5000k       Fig. 8           0.0001                 50                  25               -,25.0
                       Tik. Regul. Medium                      5000k       Fig. 8              1                   50                  25               -,23.0
                         Tik. Regul. High                      5000k       Fig. 8              10                  50                  25               -,25.0
                          Oversmoothing                        5000k       Fig. 8           0.0001                 25                  25               -,26.0
                     Tik. Regul. Low + WX                      5000k       Fig. 8           0.0001                 50                  25               X,21.0
"Table 1. Summary of the different configurations that we test in this work. The first column lists the abbreviations, the second refers to the Figure where the",0.0
"setup is analysed. The next columns list the value of the Tikhonov regularization parameter ùõº (see ¬ß 4.2.1), the number of initial bins, the effective bin number",0.0
after (potentially) applying merging bin regularization (see ¬ß 4.2.1) and an indicator if the composite likelihood includes the cross-correlation data (see ¬ß 5).,0.0
"Reg. ùõº‚Äô, ‚ÄòInitial Binning‚Äô and ‚ÄòEffective Binning‚Äô list the value of                  probability density function, the right panel the relative difference",0.0
"the Tikhonov regularization parameter ùõº (see ¬ß 4.2.1), as well as                     between these posteriors and the spectroscopic redshift distribution",0.0
"the used initial and effective bin number18 , i.e., the histogram bin                 that is shown as the black dashed line in both panels. The error",0.0
"number after the merging bin regularization scheme. The final col-                    bars are the [16, 84] percentiles, corresponding to a Gaussian ¬±1ùúé",0.0
umn indicates whether the cross-correlation data vector is included                   interval.,0.0
in the composite likelihood. Fig. 7 shows a selection of posteriors,0.0
"using setups from Tab. 1. The left hand panel shows the obtained                            The ‚ÄòSmall Sample (50k)‚Äô setup highlights the noisy, i.e.,",0.0
"                                                                                      variance-dominated deconvolution, where we clearly see the com-",86.0
                                                                                      paratively large and fluctuating errorbars in Fig. 7. We note that,86.0
"18  As an approximate rule, one can expect a noisy deconvolution if no                imposing a smoothing method will reduce these features. How-",0.0
"prior is applied, if the size of the bins is smaller than ¬±1ùúé range of the            ever this can come at the expense of additional biases as discussed",0.0
"individual galaxy redshift likelihoods for moderate sample sizes of the order         later, and the characteristic covariance structure in the posterior is",0.0
"105 galaxies. For our redshift range and photometric redshift scatter this            not a priori problematic, as long as draws from the posteriors are",0.0
would imply an effective number of bins of 30 ‚àí 40.                                   bounded and well-defined. Merging bin regularization exploits this,0.0
"                                                                                                                                        MNRAS 000, 1‚Äì22 (2015)",136.0
avr_spaces,15.3
                                                                                  Likelihood Inference under Photo-z error                          15,82.0
anti-correlation structure to provide an ‚Äòobjective‚Äô regularization           scenarios differ by their value of the Tikhonov regularization pa-,0.0
"without the need to carefully motivate an external prior or smooth-           rameter ùõº. With increasing ùõº, the error bars decrease and the bias in",0.0
ing model choice.                                                             the results increases. When comparing this with the ‚Äòoversmooth-,0.0
"      An alternative that provides additional physical motivation is          ing‚Äô results, we see the same pattern. This similarity in behaviors",6.0
the inclusion of clustering redshift measurements into the compos-            arises because both a large ùõº and choosing large bins reduces the,0.0
ite likelihood. This can be seen by comparing the posteriors from             variance of each bin.,0.0
"the ‚ÄòMedium Sample (500k)‚Äô and the ‚ÄòMedium Sample (500k), Fid.                      Finally we show the impact of including the cross-correlation",0.0
Setup & WX‚Äô cases. The corresponding results in Fig. 7 show that              measurements into the data vector in the ‚ÄòTik. Regul. Low + WX‚Äô,0.0
"for the same regularization, the inclusion of the cross-correlation           scenario, which adds clustering information to the ‚ÄòTik. Regul.",0.0
"data into the likelihood decreases the uncertainties, which is espe-          Low‚Äô scenario. When comparing these two cases, we see that the",0.0
cially visible in the high-redshift tail. We note that these results are      distribution of the posterior mean is now symmetric and reasonably,0.0
dependent on the chosen galaxy-dark matter bias model. As dis-                centered within the science requirements. In particular we note,0.0
"cussed in the beginning of this section, the parametrization used             that the uncertainties are still much larger when compared with",0.0
"here is very flexible and the effective number of parameters can              the previously considered, strongly regularized cases. This shows",0.0
"likely be reduced, if a more physical model is chosen. In this regard,        that while the effect of reducing the variance of the posteriors is",0.0
we can view the presented reduction in the statistical error due to           similar when using regularization or including cross-correlation,0.0
"clustering redshifts as conservative. As mentioned previously, bi-            data into the composite likelihood, the posteriors can be much better",0.0
"ases due to ill-motivated regularization choices play an important            calibrated in the latter case. Using a smoothing, or regularization,",0.0
"role, especially for large sample sizes, where the statistical error is       method essentially makes assumptions about the true shape of the",0.0
"small. We illustrate this here in the ‚ÄòLarge Sample (5000k) Over-             distribution without strict data evidence. In contrast, adding cross-",0.0
"smoothing‚Äô case, by deliberately choosing a coarser binning without           correlations to the composite likelihood adds this information in a",0.0
"merging bin regularization. We clearly see that the statistical error         physical, data-driven way.",0.0
is quite small with the bias dominating.                                            Another effect that needs consideration is the increase in the,0.0
"      In order to investigate the quality of probability calibration,         intrinsic estimator bias due to the ‚Äòdownsampling‚Äô of the probabil-",6.0
"we consider the posterior distribution over the mean values of pho-           ity density function to a lower resolution, e.g., by picking larger",0.0
tometric sample redshift distributions drawn from the posterior of            bin width or by imposing a different regularization or smoothing,0.0
"nB .19 This is a reasonable choice, as it has been shown that accurate        scheme. This loss in resolution implies that we inadvertently limit",0.0
modelling of weak lensing and LSS critically depends on accurate              the accuracy with which small scale structure can be reconstructed,0.0
recovery of the posterior mean.                                               in the density field along the line-of-sight. As demonstrated and,0.0
"      Fig. 8 shows five boxplots that each visualize the distribution         studied in detail in Rau et al. (2017), this effect can lead to biases",6.0
"of the posterior mean that corresponds to a different setup under             in the cosmological parameter inference that are often small, but",0.0
"consideration. The box edges denote the [16, 84] percentiles, and             that would need scrutiny for upcoming data analyses. Since we gave",0.0
"the definition of the whiskers, i.e., the thin vertical lines with short      a detailed description of this effect in Rau et al. (2017) including",0.0
"horizontal edges represent the [2.5, 97.5] percentiles. The horizon-          schemes to detect and mitigate these effects, we do not focus on it",0.0
"tal line within the box represents the median20 . The x-axis shows            in detail here. However, this effect can be illustrated for the current",0.0
"several different scenarios, as listed in Tab. 1; the y-axis shows the        setup, since the merging bin regularization downsamples the reso-",0.0
value of the posterior mean. The middle solid black line corresponds          lution to a relatively coarse grid of 31 bins. Furthermore consider,0.0
"to the mean of the true redshift distribution, shown as the dashed            the redshift distribution of true redshifts discretized using the 20 bin",0.0
black line in the left panel of Fig. 7. We reiterate that all results         grid used to obtain the cross-correlation measurements. Since we,0.0
"have been obtained using a mock catalog containing 5000k galax-               use this distribution, i.e. the black curve in Fig. 7, as a reference, we",0.0
"ies. The (dashed/dotted), (grey/magenta) horizontal lines represent           also have to consider its intrinsic discretization error. Concretely,",0.0
"the requirement values for (Y1/Y10), (LSS/WL) measurements as                 when comparing the mean estimated from this curve with the sam-",0.0
"given in the LSST DESC Science Requirements Document (DESC                    ple mean, we obtain a difference in these values of 0.0079. While",0.0
"SRD The LSST Dark Energy Science Collaboration et al. 2018).                  this is of the same order as the Y1 science requirements in Fig. 8,",0.0
We note that the LSST DESC Science Requirements Documents                     Y10 requirements will necessitate an increase in sample size or,0.0
"considers a tomographic analysis and not a single bin, as we do               the inclusion of cross-correlation constraints that will allow us to",0.0
here. We therefore restrict ourselves to a qualitative comparison.            perform inference at a higher resolution. Due to the slow expected,0.0
Furthermore it should be noted that higher order moments of the               convergence of deconvolution estimators with sample size (see e.g.,0.0
"photometric sample redshift distribution will also correlate with             Carroll & Hall 1988), it is likely that several orders of magnitude",0.0
"cosmological parameters, especially for a clustering likelihood (see          increase in sample size will be necessary. This is attainable for the",0.0
"e.g. Nicola et al. 2020; Hadzhiyska et al. 2020), and our metric              large numbers of observed galaxies in LSST Y10, and our method-",0.0
"is therefore bound to be incomplete. Redefining these metrics and             ology can scale to large sample sizes. However, in order to reach",0.0
"requirements is the subject of ongoing work.                                  the sample sizes that are expected for LSST observations, we need",0.0
"      We consider three scenarios: ‚ÄòTik Regul. Low‚Äô, ‚ÄòTik. Regul.             to develop an implementation that optimizes storage space and uses",6.0
"Medium‚Äô and Tik. Regul. High‚Äô. As can be seen from Tab. 1 these               an efficient parallelization strategy, which is beyond the scope of",0.0
                                                                              this work.,78.0
"19                                                                                  Alternatively, we could use a different scheme that employs a",0.0
"    Concretely, we draw a number of ùëõ ùêµ realizations that each parametrize",4.0
a photometric sample redshift distribution and evaluate the mean on each of   continuous model like logistic Gaussian processes (Rau et al. 2020),0.0
these distributions.                                                          or Dirichlet processes. The convergence of these density estimators,0.0
"20 We note that the original definition of the boxplot uses a different defi- will likely be better, however they will also require additional com-",0.0
nition of the box size and the whiskers. We refer to Wickham & Stryjewski     putational overhead in the inference. A detailed study of estimator,0.0
(2012) for more details.                                                      convergence is needed to settle on a recommendation and prove sig-,0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,2.8484848484848486
16,0.0
                   0.94,19.0
                                                                 DESC SRD Y10 WL                                 0.2,65.0
                   0.93                                          DESC SRD Y1 WL,19.0
                   0.92,19.0
                                                                 DESC SRD Y10 LSS,65.0
                                                                 DESC SRD Y1 LSS                                 0.1,65.0
Posterior Mean z                                                                              wRB,0.0
                                                                                               PostPred w Meas,95.0
                   0.91,19.0
                                                                                                         RB,105.0
                   0.90                                                                                          0.0,19.0
                   0.89,19.0
                                                                                                                 0.1         Unbiased,113.0
                   0.88                                                                                                      Biased = 0.8 Sys. Marg.,19.0
                   0.87,19.0
                                                                                                                             Biased Fixed Bias = 0.8,125.0
                                                                                                                 0.2         Biased Marg. Bias = 0.8,113.0
                          Tik. Regul.   Tik. Regul.   Tik. Regul. Oversmoothing Tik. Regul.,26.0
                              Low        Medium          High                   Low + WX                               0.0    0.5      1.0      1.5      2.0     2.5     3.0,30.0
                                                                                                                                             Redshift,141.0
Figure 8. Boxplot illustration of the mean of the posterior sample redshift,0.0
probability density function of the photometric sample (short: posterior,0.0
mean) for different experimental setups listed in Tab. 1 and detailed in ¬ß 8.                 Figure 9. We plot the residual between replicated and true scale-averaged,0.0
"The x-axis lists the different scenarios, the y-axis the value of the posterior               cross-correlation measurement wRB between a DESI-like spectroscopic ref-",0.0
"mean. The box shows the [16, 84] percentiles, the vertical lines with hori-                   erence (‚ÄòR‚Äô) and photometric base (‚ÄòB‚Äô) sample as a function of redshift.",0.0
"zontal edges (whiskers) show the [2.5, 97.5] percentiles, corresponding to                    The horizontal line with errorbars shows the uncertainties in the original",0.0
the 1ùúé and 2ùúé intervals for the normal distribution. The horizontal line in                   measurement. The green/magenta contours show the scenario where we,0.0
"the box is the median. The (dashed/dotted), (grey/magenta) lines correspond                   marginalize over all parameters c that parametrize the redshift dependent",0.0
to the requirement on the uncertainty of the posterior mean as quoted in the                  galaxy-dark matter bias ratio function ùê∂ (ùëß) (see ¬ß 8.1) without the sys-,0.0
"LSST DESC Science Requirements Document (DESC SRD, The LSST                                   tematics kernel for the unbiased/biased ( ùëì = 0.8) cases. The yellow/blue",0.0
"Dark Energy Science Collaboration et al. 2018) for (Y1/Y10) (LSS/WL)                          contours consider the biased scenario ( ùëì = 0.8), but fix ùê∂ (ùëß) and do/do",0.0
"measurements. The central, solid grey line is the mean of the true redshift                   not marginalize over the systematics kernel. The error bars and contours",0.0
"distribution, shown as the dashed black line in the left panel of Fig. 7. All                 show the [5, 95] percentiles. We see that the replicated measurements do",0.0
"results have been obtained using a mock catalog of 5000k galaxies with                        not show significant tension with the original measurements, if we either",0.0
photometric redshift scatter that is perfectly calibrated. We highlight the                   marginalize over the systematic (‚ÄòBiased f=0.8 Sys. Marg.‚Äô) or if we use a,0.0
decrease in the statistical error and potential increase in systematic bias for               flexible redshift-dependent galaxy-dark matter bias model (‚ÄòBiased Marg.,0.0
"larger regularization, going from the leftmost to the fourth case. The right-                 Bias f=0.8‚Äô). Only if the form of the galaxy-dark matter bias is known to",0.0
most boxplot shows the impact of including clustering redshift information                    good precision ‚Äì in this case we hold its values fixed ‚Äì are PPCs using,0.0
into the likelihood.                                                                          cross-correlations sensitive in detecting tensions.,0.0
nificant improvement over the simple histogram scheme employed,0.0
                                                                                              rameters that describe properties of the Spectral Energy Distribution,94.0
here; we will leave this for future work.,0.0
"                                                                                              (SED). In conditional density estimation, non-physical parameters",94.0
"      Most importantly, however, it is likely that systematic errors",6.0
                                                                                              describe a flexible model that provides a mapping between photom-,94.0
due to the miscalibration and mis-specification of the composite,0.0
                                                                                              etry and redshift. This flexible model is then fitted to known cali-,94.0
"likelihood, either by a suboptimal galaxy-dark matter bias model",0.0
                                                                                              bration data. Thus while in SED fitting the distribution of redshift,94.0
"or due to miscalibrated SED likelihoods, will lead to an error",0.0
"                                                                                              constitutes a posterior distribution, conditional density estimation",94.0
budget that will dominate the aforementioned errors. If the mis-,0.0
                                                                                              treats it as a predictive distribution (often without marginalizing,94.0
"specification can be parametrized and marginalized over, the vari-",0.0
                                                                                              over the modelling uncertainty). However since the goal of this,94.0
"ance of the parameter posteriors will be increased, otherwise they",0.0
                                                                                              subsection is to demonstrate potential systematic biases and uncer-,94.0
will lead to biases in the resulting parameter posteriors. In the,0.0
"                                                                                              tainties in the deconvolution operation, this difference is not of great",94.0
following section we will discuss these sources of error. We will,0.0
                                                                                              importance here.,94.0
showcase the usage of posterior predictive checks as a way to detect,0.0
                                                                                                    In order to simulate the impact that a population of galaxies,100.0
miscalibration and suggest procedures for consistent model check-,0.0
                                                                                              with inaccurately calibrated photometric redshift likelihoods has on,94.0
ing and refinement.,0.0
"                                                                                              the deconvolved redshift distribution, we consider a redshift range of",94.0
                                                                                              0.2 ‚àí 0.8 and a total of 500k galaxies. We randomly substitute 80%,94.0
                                                                                              of the FlexZboost conditional density predictions with photometric,94.0
8.3                 Testing the Model,0.0
                                                                                              likelihoods obtained using a template fitting run from the BPZ code,94.0
We discussed and showcased our inference methodology in the pre-                              by employing a k-nearest neighbor substitution in redshift. The result,0.0
"vious section using idealized data. To complement the discussion,                             is a dataset in which a fraction of 80% ( ùëì = 0.8) of galaxies have a",0.0
"this section highlights how miscalibrated likelihoods can lead to                             likelihood from the BPZ code, and only 20% retain their conditional",0.0
biases in the inferred sample redshift distribution and how posterior                         density predictions from the FlexZboost code. We picked this setup,0.0
"predictive checks can be used to detect these issues.                                         because the BPZ predictions within this redshift range, while be-",0.0
"      To mimic well-calibrated photometric likelihoods we use con-                            ing inferior to the FlexZboost predictions, still have an acceptable",6.0
ditional density estimates from the FlexZboost package (Dalmasso                              quality. We perform this experiment by selecting a range in redshift,0.0
et al. 2020). We note that these conditional densities are not photo-                         because we will perform posterior predictive checks (PPC) using,0.0
metric likelihoods in the sense of Eq. (34). The free parameters in                           cross-correlations and need to control where we would expect sys-,0.0
the photometric likelihood are the redshifts of the galaxies and pa-                          tematics. This will allow us to disentangle model misspecification,0.0
"                                                                                                                                                        MNRAS 000, 1‚Äì22 (2015)",152.0
avr_spaces,34.083333333333336
                                                                              Likelihood Inference under Photo-z error                       17,78.0
"issues from the systematics, e.g. from the ‚Äònoisy‚Äô deconvolution,         the deconvolved density estimate using, e.g., a convolution with a",0.0
described previously. We note that the quality of photometric red-        kernel function as described in ¬ß 7.2. We show these results as the,0.0
"shift likelihoods does not sharply change with redshift in this way,      yellow lines ‚ÄòBiased ùëì = 0.8 Sys. Marg‚Äô. Here we perform a dis-",0.0
"in real photometric samples. Instead photometric redshift quality         cretized marginalization as described in ¬ß 7.2, by convolving the nB",0.0
"is a complex function in color space that strongly depends e.g. on        vector with a Gaussian kernel function of width Œîùúé ‚àà [0.001, 0.2]",0.0
"the quality of the photometry, the number of available bands, the         in 40 steps. We see that this correction can compensate for the",0.0
amount of calibration data and the template set. Modelling this ac-       misspecified likelihoods even in the case of a fixed ùê∂ (ùëß) model.,0.0
curately is beyond the scope of this work and would require the           The degeneracy between the redshift-dependent galaxy-dark matter,0.0
measurement of cross-correlations in color cells and the extension        bias ratio model and the nB parameters highlights the importance,0.0
"of PPC to the full composite likelihood, that includes sampling the       of performing posterior predictive checks in color space to provide",0.0
"photometry of galaxies in these color cells. Using the mean of the        additional information on the redshift distribution. However, this",0.0
FlexZboost conditional densities for the selection instead of the true    requires careful modelling of SEDs and the development of a trans-,0.0
"redshifts would ‚Äòsmooth-out‚Äô the quality of the likelihoods as a func-    parent, reproducible analysis framework that additionally includes",0.0
tion of redshift at the boundaries of the 0.2 ‚àí 0.8 redshift interval.    tests for parameter degeneracies and a model comparison frame-,0.0
"However this will also not be representative of the aforementioned        work. This is beyond the scope of this work, but will be addressed",0.0
difficulties. We therefore choose an unrealistically simple case that     in a future paper.,0.0
nonetheless illustrates the usefulness of PPC. Furthermore it allows,0.0
us to highlight difficulties in their application in a controlled man-,0.0
"ner, by picking a fixed redshift range in which individual galaxy",0.0
likelihoods are biased.                                                   9    SUMMARY AND CONCLUSIONS,0.0
"      In the spirit of PPC, we generate new cross-correlation mea-        Accurate photometric redshift inference is one of the most impor-",6.0
"surements using the joint posterior of the sample redshift distribu-      tant challenges in large area photometric surveys like LSST, DES,",0.0
"tion parameters nB and the parameters that govern the galaxy-dark         HSC, or KiDS. As discussed in detail in ¬ß 3, photometric redshift",0.0
"matter bias ratio evolution c, following the Chebychev basis ex-          inference is, from a statistical point of view, a deconvolution prob-",0.0
"pansion described in ¬ß 8.1. For simplicity we will deconvolve the         lem, where an underlying true redshift distribution is convolved",0.0
redshift distribution on the same 20 bin redshift grid used in the        with an SED model-dependent error distribution given by the pho-,0.0
"cross-correlation data vector. For 500k galaxies, this leads to very      tometric likelihood. The deconvolution inference of sample redshift",0.0
small statistical errorbars in the deconvolution. As a simplification     distribution is not new (e.g. Padmanabhan et al. 2005; Leistedt et al.,0.0
"we can then fix the nB posterior to its maximum likelihood value.         2016; Malz & Hogg 2020), and spatial information has also been",0.0
"As mentioned in the previous section, this oversmoothing will lead        incorporated into the inference (e.g. Alarcon et al. 2020b; S√°nchez",0.0
"to biases in the nB posteriors. However, since we will only perform       & Bernstein 2019; Jones & Heavens 2019; Rau et al. 2020). We ex-",0.0
a posterior predictive analysis with respect to the clustering likeli-    tended these prior works by developing a fast approximate inference,0.0
"hood, that is less constraining than the photometric likelihood, the      scheme for deconvolution, that combines redshift information from",0.0
systematics incurred by these simplifications and the underestima-        both the photometry and the spatial distribution of galaxies in terms,0.0
"tion of statistical error, are sub-dominant compared with the overall     of a composite likelihood ansatz. We particularly provided a discus-",0.0
statistical error budget from the correlation function measurements.      sion on regularization techniques and the tradeoff between bias and,0.0
                                                                          variance in the Bayesian context for medium to large sample sizes.,74.0
"      Fig. 9 shows the sampled cross correlation measurements from              In particular, our goal is to include the treatment of photomet-",6.0
"the fitted joint model, in residual to the original measurements. We      ric redshift via the likelihood of the galaxies‚Äô photometry into the",0.0
"showcase four scenarios. In the unbiased case we use FlexZBoost           current cosmological inference framework, which is based on cor-",0.0
PDFs and marginalize over all c parameters. Due to the good cal-          relation functions. The main reason for our likelihood choice is to,0.0
ibration of these Machine Learning-produced conditional distribu-         allow the easy integration into the likelihood inference framework,0.0
"tions, we obtain very similar results compared with the previous          based on two-point statistics of galaxy density and shear fields. This",0.0
"section. The reason for this success is, of course, the representative    is more difficult for other approaches presented in Alarcon et al.",0.0
"training set that would not be available in a practical application.      (2020b) and S√°nchez & Bernstein (2019) since, in the currently",0.0
"Furthermore we consider three scenarios with ùëì = 0.8. The sce-            demonstrated form, the redshift information from cross-correlating",0.0
nario shown in yellow fixes the galaxy-dark matter bias parameters        the overlapping spectroscopic sample is included via an estimator,0.0
"(c), but marginalizes over the parameters of the systematics kernel.      and not using a likelihood (that would depend on cosmological",0.0
"The blue/magenta lines fix/marginalize over the c parameters, but         parameters). While the works of Padmanabhan et al. (2005); Leist-",0.0
do not include the systematics kernel correction.                         edt et al. (2016); Malz & Hogg (2020) are structurally similar in,0.0
"      As can be seen in Fig. 9, the treatment of galaxy-dark matter       terms of the treatment of the photometric likelihood, they do not",6.0
bias has a profound impact on the consistency between the replicated      discuss the effect of including clustering information. It is notewor-,0.0
"and original cross-correlation measurements. Within the errors, the       thy that the early work by Padmanabhan et al. (2005) provides an",0.0
"results are consistent for all scenarios except the one without sys-      excellent, explicit discussion of regularization, which is the main",0.0
"tematics kernel correction that uses a fixed ùê∂ (ùëß) model. As shown        difficulty in the photometric redshift problem, although not in the",0.0
"in the yellow line, these biases can be corrected by the systematics      context of probability calibration and the aforementioned joint in-",0.0
kernel marginalization. This illustrates that if sufficient information   ference framework. We summarized our approach to the challenges,0.0
"about ùê∂ (ùëß) is available, the clustering likelihood alone can allow for   that arise in the estimation of redshift distributions for samples of",0.0
"powerful posterior predictive checks. If this is not the case, consis-    galaxies in the context of photometric surveys. Concretely, we con-",0.0
tency tests of redshift distributions with respect to clustering redshift sidered the combination of photometric information with two-point,0.0
"measurements can be misleading. Provided sufficient information           statistics, the scalability and regularization of the deconvolution in-",0.0
"on the galaxy-dark matter bias, we can parametrize the biases in          ference in the large sample scenario, and investigate the impact of",0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,2.6153846153846154
18,0.0
systematics from misspecified individual galaxy photometric like-      measurement to evaluate model goodness-of-fit. Specifically cross-,0.0
"lihoods, proposing parametrizations for these systematics. These       correlation redshift inference is often used to calibrate photometric",0.0
achievements lay the foundations for future extensions that we will    redshifts obtained using photometry (Newman 2008; Johnson et al.,0.0
discuss in the next section.                                           2016; Davis et al. 2017). In ¬ß 8.3 we demonstrated that PPC of,0.0
      In ¬ß 4.1 we described our inference methodology that is de-      cross-correlation measurements can detect systematic biases in the,6.0
signed to facilitate inference on large galaxy catalogs to be expected recovered sample redshift distribution if the galaxy-dark matter bias,0.0
in LSST. The scheme uses a Laplace Approximation in logit space        of the photometric and spectroscopic samples is known to sufficient,0.0
and facilitates inference using an iterative scheme of expectation     accuracy.,0.0
maximization update equations. This provides computational ad-               In order to parametrize potential biases in the sample redshift,0.0
vantages over sampling approaches. Additionally this methodology       distribution posteriors caused by misspecified photometric likeli-,0.0
"facilitates fast joint inference with a cross-correlation data vector  hoods, particularly over-deconvolution effects that lead to overly",0.0
"(see ¬ß 5) that we included in a composite likelihood ansatz. As high-  narrow redshift distributions, we proposed a simple Gaussian filter",0.0
"lighted in ¬ß 6, this provides the possibility of additional extensions that, as demonstrated in ¬ß 8.3, was able to correct these biases.",0.0
that include two-point statistics from cosmological weak lensing,0.0
"and galaxy-galaxy lensing measurements. As we discussed in ¬ß 3,",0.0
ensemble redshift distribution inference based on a photometric,0.0
"likelihood is a deconvolution problem, which requires regulariza-      10    FUTURE WORK",0.0
"tion to yield bounded and well-defined results. In this context, we",0.0
"                                                                       In future work, it will be important to extend the inference scheme",71.0
discussed a regularization scheme that consists of a combination,0.0
"                                                                       developed in this paper. We plan to consider a range of extensions,",71.0
of Tikhonov regularization with (more importantly) a scheme that,0.0
"                                                                       e.g., iterated nested Laplace approximations (Bornkamp 2011) in",71.0
merges neighboring bins to exploit the characteristic covariance,0.0
"                                                                       logit space, the usage of more flexible distributions that can be fitted",71.0
structure in the deconvolved densities. In agreement with the find-,0.0
"                                                                       using variational inference schemes, as well as the development of",71.0
ings of the original paper by Kuusela (2016) that proposed and,0.0
                                                                       specialized subsampling MCMC schemes. The different techniques,71.0
"applied this scheme to the Poisson inverse problem, we find that the",0.0
                                                                       will be evaluated in combination with regularization approaches,71.0
‚ÄòMerging Bin‚Äô scheme leads to better calibrated results as compared,0.0
                                                                       based on the quality of their probability coverage. Another exten-,71.0
with Tikhonov regularization and with an oversmoothing scheme,0.0
"                                                                       sion, particularly to reduce the bias in the density estimation, is to",71.0
that selects a coarser redshift binning for the sample redshift his-,0.0
                                                                       consider other parametrizations for the deconvolved density either,71.0
tograms.,0.0
                                                                       by employing density estimators with better mean squared error,71.0
      In order to test and discuss the quality of our posterior infer-,6.0
"                                                                       scaling like Kernel Density estimators, basis function expansions or",71.0
"ence, we used data from the CosmoDC2 simulations to generate a",0.0
                                                                       using methods such as logistic Gaussian Processes (e.g. Rau et al.,71.0
"spectroscopic DESI-like sample and a photometric mock catalog,",0.0
                                                                       2020). The combination of photometric and clustering information,71.0
that uses an LSST-like photometric error model. This allowed us to,0.0
                                                                       can be extended by connecting the modelling of SEDs and redshift-,71.0
test the impact of a spectroscopic calibration sample with an inho-,0.0
                                                                       dependent galaxy-dark matter bias modelling via the luminosity,71.0
mogeneous galaxy population as a function of redshift. We found,0.0
                                                                       function as shown in van Daalen & White (2018). This also has,71.0
that the ratio between the redshift-dependent galaxy-dark matter,0.0
                                                                       the potential to reduce the degeneracy between SED and redshift-,71.0
bias of the photometric and the spectroscopic sample is a smooth,0.0
"                                                                       dependent galaxy-dark matter bias systematics. Finally, we note that",71.0
"function of redshift, if the spectroscopic calibration sample consists",0.0
                                                                       the data quality of the photometry will not be the same in all areas,71.0
"of a single galaxy population, and is discontinuous if the galaxy",0.0
                                                                       on the sky. In order to include these field-to-field variations into the,71.0
population strongly changes. We therefore employed a step-wise,0.0
"                                                                       composite likelihood framework, we can, for example, condition the",71.0
smooth function based on a Chebychev polynomial expansion to,0.0
                                                                       likelihood on the field and include a corresponding data covariance,71.0
parametrize this ratio.,0.0
                                                                       into the likelihood by employing either resampling techniques (see,71.0
      In ¬ß 8 we performed a forecast of redshift inference perfor-,6.0
                                                                       e.g. Davison & Hinkley 2013) or using theoretical modelling (e.g.,71.0
"mance on ideal data, assuming perfectly calibrated individual galaxy",0.0
                                                                       Stoyan & Stoyan 1994; S√°nchez et al. 2020).,71.0
redshift likelihoods. We found that using the aforementioned merg-,0.0
"                                                                             To conclude, we have presented an efficient photometric red-",77.0
"ing bin regularization, we were able to produce accurate posteriors",0.0
                                                                       shift inference framework that combines information from both the,71.0
of ensemble redshift distributions. We reiterate that using other reg-,0.0
                                                                       photometry and the spatial distribution of galaxies. The methodol-,71.0
"ularization schemes, like an overly large Tikhonov regularization",0.0
                                                                       ogy is designed to scale well to large samples. We complement this,71.0
"parameter, or an oversmoothing approach that picks overly wide",0.0
"                                                                       framework with methods for regularization, model checking and",71.0
"histogram bins, can lead to significant biases in the recovered pos-",0.0
                                                                       redshift systematics parametrization. The forecasts we performed,71.0
terior mean.,0.0
"                                                                       using CosmoDC2 data give us confidence that, with the additional",71.0
      When compared with the DESC science requirements for WL,6.0
"                                                                       improvements described here, the methodology presented will en-",71.0
and large scale structure measurements in terms of the mean of,0.0
                                                                       able accurate and well-calibrated redshift inference for LSST and,71.0
"the photometric sample redshift distribution, we found that we can",0.0
                                                                       other ongoing and future large area photometric surveys.,71.0
meet the DESC SRD Y1 goals and remain consistent with the DESC,0.0
"SRD Y10 goals with 5000k galaxies, if cross-correlations are in-",0.0
"cluded in the joint composite likelihood. In practical applications,",0.0
"however, Spectral Energy Distribution (SED) templates for galaxies",0.0
                                                                       SOFTWARE,71.0
will be subject to modelling biases that cannot be well calibrated,0.0
"using spectroscopic data (see e.g. Hartley et al. 2020). We therefore  Besides software referenced directly in the text, we performed the",0.0
proposed to use posterior predictive checks (PPC) as a means to        analyses in this work using the following software packages: the,0.0
"evaluate the quality of our inference. Here, we compared replica-      python language (van Rossum 1995), scipy (Virtanen et al. 2020),",0.0
"tions of the data sampled from the fitted model with the original      numpy (Harris et al. 2020), jupyter notebook (Kluyver et al. 2016),",0.0
"                                                                                                                     MNRAS 000, 1‚Äì22 (2015)",117.0
avr_spaces,27.19607843137255
                                                                         Likelihood Inference under Photo-z error                              19,73.0
"ipython (Perez & Granger 2007), matplotlib (Hunter 2007) and         under Contract No. DE-AC02-05CH11231; STFC DiRAC HPC Fa-",0.0
"pandas (Wes McKinney 2010).                                          cilities, funded by UK BIS National E-infrastructure capital grants;",0.0
"                                                                     and the UK particle physics grid, supported by the GridPP Col-",69.0
                                                                     laboration. This work was performed in part under DOE Contract,69.0
                                                                     DE-AC02-76SF00515.,69.0
DATA AVAILABILITY STATEMENT,0.0
The cosmoDC2 extragalactic catalog is publicly available at,0.0
https://portal.nersc.gov/project/lsst/cosmoDC2/                      REFERENCES,0.0
_README.html. The ancillary catalogs (photo-z and DESI-like,0.0
"                                                                     Abbott T. M. C., et al., 2018a, Phys. Rev. D, 98, 043526",69.0
selection for cosmoDC2) and other derived data underlying this,0.0
"                                                                     Abbott T. M. C., et al., 2018b, ApJS, 239, 18",69.0
article will be shared on reasonable request to the corresponding,0.0
"                                                                     Aihara H., et al., 2018, PASJ, 70, S4",69.0
"author. The source code that implements the algorithms presented     Alarcon A., et al., 2020a, arXiv e-prints, p. arXiv:2007.11132",0.0
"in this article will be made available via Zenodo.                   Alarcon A., S√°nchez C., Bernstein G. M., Gazta√±aga E., 2020b, MNRAS,",0.0
"                                                                          498, 2614",74.0
"                                                                     Albrecht A., et al., 2006, arXiv e-prints, pp astro‚Äìph/0609591",69.0
"                                                                     Arnouts S., Cristiani S., Moscardini L., Matarrese S., Lucchin F., Fontana",69.0
"ACKNOWLEDGEMENTS                                                          A., Giallongo E., 1999, MNRAS, 310, 540",0.0
"                                                                     Atchison J., Shen S., 1980, Biometrika, 67, 261",69.0
"This paper has undergone internal review in the LSST Dark Energy     Ben√≠tez N., 2000, ApJ, 536, 571",0.0
"Science Collaboration. We would like to thank the internal reviewers Benjamin J., et al., 2013, MNRAS, 431, 1547",0.0
"David Alonso, Will Hartley and David Kirkby for their insightful     Benson A. J., 2012, New Astron., 17, 175",0.0
"comments.                                                            Bernstein G., Huterer D., 2010, MNRAS, 401, 1399",0.0
"      MMR led and planned the project from the initial idea and      Bishop C. M., 2006, Pattern Recognition and Machine Learning (Informa-",6.0
"motivation to the experimental design. He performed the analyses          tion Science and Statistics). Springer-Verlag, Berlin, Heidelberg",0.0
"                                                                     Bonnett C., 2015, MNRAS, 449, 1043",69.0
"in interaction with the coauthors, and prepared the paper. CBM",0.0
"                                                                     Bornkamp B., 2011, Journal of Computational and Graphical Statistics, 20,",69.0
"contributed by: development of clustering redshifts software, cre-",0.0
                                                                          656,74.0
"ation of clustering redshifts photometric and spectroscopic sam-     Box G. E. P., Muller M. E., 1958, Ann. Math. Statist., 29, 610",0.0
"ples, creation of clustering redshift data products. SJS constructed Brown M. J. I., et al., 2014, ApJS, 212, 18",0.0
"the photometric redshift catalogs and contributed to writing the     Carrasco Kind M., Brunner R. J., 2013, MNRAS, 432, 1483",0.0
"corresponding portions of the paper. SW provided feedback on the     Carroll R. J., Hall P., 1988, Journal of the American Statistical Association,",0.0
"method development and manuscript. RM advised on motivation,              83, 1184",0.0
"scope, experimental design, and analysis, and contributed to the     Cawthon R., et al., 2020, arXiv e-prints, p. arXiv:2012.12826",0.0
"editing of the paper draft. YYM developed the access tools for       Chang C., et al., 2016, MNRAS, 459, 3203",0.0
"cosmoDC2 and photo-z data products.                                  Chen T., Guestrin C., 2016, in Proceedings of the 22Nd ACM",0.0
      MMR and RM are supported by DOE grant DE-SC0010118                  SIGKDD International Conference on Knowled ge Discovery,6.0
"                                                                          and Data Mining. KDD ‚Äô16. ACM, New York, NY, USA, pp",74.0
and NSF grant IIS-1563887. SJS acknowledges support from DOE,0.0
"                                                                          785‚Äì794, doi:10.1145/2939672.2939785, http://doi.acm.org/10.",74.0
grant DESC0009999 and NSF/AURA grant N56981C. MMR was                     1145/2939672.2939785,0.0
"supported in part by the Simons Foundation (Simons Investigator      Clerkin L., Kirk D., Lahav O., Abdalla F. B., Gazta√±aga E., 2015, MNRAS,",0.0
"Award, PI: Mandelbaum). This material is based upon work sup-             448, 1389",0.0
"ported in part by the National Science Foundation through Cooper-    Collister A. A., Lahav O., 2004, Publications of the Astronomical Society",0.0
"ative Agreement 1258333 managed by the Association of Univer-             of the Pacific, 116, 345",0.0
"sities for Research in Astronomy (AURA), and the Department of       Craig I. J. D., Brown J. C., 1986, Inverse problems in astronomy. A guide to",0.0
Energy under Contract No. DE-AC02-76SF00515 with the SLAC                 inversion strategies for remotely sensed data,0.0
"National Accelerator Laboratory. Additional LSST funding comes       DESI Collaboration et al., 2016, arXiv e-prints, p. arXiv:1611.00036",0.0
"from private donations, grants to universities, and in-kind support  Dalmasso N., Pospisil T., Lee A. B., Izbicki R., Freeman P. E., Malz A. I.,",0.0
"                                                                          2020, Astronomy and Computing, 30, 100362",74.0
from LSSTC Institutional Members. SJS acknowledges support,0.0
"                                                                     Davis C., et al., 2017, arXiv e-prints, p. arXiv:1710.02517",69.0
from DOE grant DE-SC0009999 and NSF/AURA grant N56981C.,0.0
"                                                                     Davison A. C., Hinkley D. V., 2013, Bootstrap Methods and Their Applica-",69.0
"Support for YYM was provided by NASA through the NASA Hub-                tion. Cambridge University Press, USA",0.0
"ble Fellowship grant no. HST-HF2-51441.001 awarded by the Space      Feldmann R., et al., 2006, MNRAS, 372, 565",0.0
"Telescope Science Institute, which is operated by the Association of Gatti M., et al., 2018, MNRAS, 477, 1664",0.0
"Universities for Research in Astronomy, Incorporated, under NASA     Gatti M., et al., 2020, arXiv e-prints, p. arXiv:2012.08569",0.0
"contract NAS5-26555.                                                 Gelman A., li Meng X., Stern H., 1996, Statistica Sinica, pp 733‚Äì807",0.0
"      The DESC acknowledges ongoing support from the Insti-          Gelman A., Hwang J., Vehtari A., 2013, arXiv e-prints, p. arXiv:1307.5928",6.0
"tut National de Physique Nucl√©aire et de Physique des Particules     Gerdes D. W., Sypniewski A. J., McKay T. A., Hao J., Weis M. R., Wechsler",0.0
"in France; the Science & Technology Facilities Council in the             R. H., Busha M. T., 2010, ApJ, 715, 823",0.0
"                                                                     Graham M. L., et al., 2020, AJ, 159, 258",69.0
"United Kingdom; and the Department of Energy, the National Sci-",0.0
"                                                                     Greisel N., Seitz S., Drory N., Bender R., Saglia R. P., Snigula J., 2015,",69.0
"ence Foundation, and the LSST Corporation in the United States.",0.0
"                                                                          MNRAS, 451, 1848",74.0
"DESC uses resources of the IN2P3 Computing Center (CC-IN2P3‚Äì         Hadzhiyska B., Alonso D., Nicola A., Slosar A., 2020, arXiv e-prints, p.",0.0
Lyon/Villeurbanne - France) funded by the Centre National de la           arXiv:2007.14989,0.0
"Recherche Scientifique; the National Energy Research Scientific      Hahn C., Beutler F., Sinha M., Berlind A., Ho S., Hogg D. W., 2019,",0.0
"Computing Center, a DOE Office of Science User Facility sup-              MNRAS, 485, 2956",0.0
"ported by the Office of Science of the U.S. Department of Energy     Harris C. R., et al., 2020, Nature, 585, 357‚Äì362",0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,19.873417721518987
20,0.0
"Hartley W. G., et al., 2020, MNRAS, 496, 4769                                 Rau M. M., Seitz S., Brimioulle F., Frank E., Friedrich O., Gruen D., Hoyle",0.0
"Hearin A., Korytov D., Kovacs E., Benson A., Aung H., Bradshaw C.,                 B., 2015, MNRAS, 452, 3710",0.0
"    Campbell D., LSST Dark Energy Science Collaboration 2020, MNRAS,          Rau M. M., Hoyle B., Paech K., Seitz S., 2017, MNRAS, 466, 2927",4.0
"    495, 5040                                                                 Rau M. M., Wilson S., Mandelbaum R., 2020, MNRAS, 491, 4768",4.0
"Heitmann K., et al., 2019, ApJS, 245, 16                                      Raue A., Kreutz C., Theis F., Timmer J., 2013, Philosophical transac-",0.0
"Heymans C., et al., 2020, arXiv e-prints, p. arXiv:2007.15632                      tions. Series A, Mathematical, physical, and engineering sciences, 371,",0.0
"Hikage C., et al., 2019, PASJ, 71, 43                                              20110544",0.0
"Hildebrandt H., et al., 2017, MNRAS, 465, 1454                                Rothenberg T. J., 1971, Econometrica, 39, 577",0.0
"Hildebrandt H., et al., 2020, arXiv e-prints, p. arXiv:2007.15635             Salvato M., Ilbert O., Hoyle B., 2019, Nature Astronomy, 3, 212",0.0
"Hoyle B., 2016, Astronomy and Computing, 16, 34                               S√°nchez C., Bernstein G. M., 2019, MNRAS, 483, 2801",0.0
"Hoyle B., Rau M. M., 2019, MNRAS, 485, 3642                                   S√°nchez C., Raveri M., Alarcon A., Bernstein G. M., 2020, MNRAS,",0.0
"Hoyle B., Rau M. M., Bonnett C., Seitz S., Weller J., 2015, MNRAS, 450,       Schmidt S. J., M√©nard B., Scranton R., Morrison C., McBride C. K., 2013,",0.0
"    305                                                                            MNRAS, 431, 3307",4.0
"Hoyle B., et al., 2018, MNRAS, 478, 592‚Äì610                                   Scottez V., et al., 2016, MNRAS, 462, 1683",0.0
"Hunter J. D., 2007, Computing in Science Engineering, 9, 90                   Scranton R., et al., 2005, ApJ, 633, 589",0.0
"Huterer D., Takada M., Bernstein G., Jain B., 2006, MNRAS, 366, 101           Simon P., Hilbert S., 2018, A&A, 613, A15",0.0
"Huterer D., Lin H., Busha M. T., Wechsler R. H., Cunha C. E., 2014,           Speagle J. S., Eisenstein D. J., 2015, arXiv e-prints, p. arXiv:1510.08073",0.0
"    MNRAS, 444, 129                                                           Spergel D., et al., 2015, arXiv e-prints, p. arXiv:1503.03757",4.0
"Ilbert O., et al., 2006, A&A, 457, 841                                        St√∂lzner B., Joachimi B., Korn A., Hildebrandt H., Wright A. H., 2020,",0.0
"Iveziƒá ≈Ω., et al., 2019, ApJ, 873, 111                                             arXiv e-prints, p. arXiv:2012.07707",0.0
"                                                                              Stoyan D., Stoyan H., 1994, Fractals, Random Shapes and Point",78.0
"Izbicki R., Lee A. B., 2017, Electron. J. Statist., 11, 2800",0.0
                                                                                   Fields: Methods of Geometrical Statistics. Wiley Series in Probabil-,83.0
"Johnson A., et al., 2016, MNRAS, 465, 4118",0.0
"                                                                                   ity and Statistics, Wiley, https://books.google.com/books?id=",83.0
"Jones D. M., Heavens A. F., 2019, MNRAS, 483, 2487",0.0
                                                                                   Dw3vAAAAMAAJ,83.0
"Joudaki S., et al., 2018, MNRAS, 474, 4894",0.0
"                                                                              Tagliaferri R., Longo G., Andreon S., Capozziello S., Donalek C., Giordano",78.0
"Joudaki S., et al., 2020, A&A, 638, L1",0.0
"                                                                                   G., 2003, Neural Networks for Photometric Redshifts Evaluation. pp",83.0
"Kalmbach J. B., Connolly A. J., 2017, AJ, 154, 277",0.0
"                                                                                   226‚Äì234, doi:10.1007/978-3-540-45216-4_26",83.0
"Kluyver T., et al., 2016, in Loizides F., Schmidt B., eds, Positioning and",0.0
"                                                                              Tanaka M., et al., 2018, PASJ, 70, S9",78.0
"    Power in Academic Publishing: Players, Agents and Agendas. pp 87 ‚Äì",4.0
"                                                                              The LSST Dark Energy Science Collaboration et al., 2018, arXiv e-prints,",78.0
    90,4.0
                                                                                   p. arXiv:1809.01669,83.0
"Korytov D., et al., 2019, ApJS, 245, 26                                       Uitert E., et al., 2017, MNRAS, 476",0.0
"Kress R., 1998, Numerical Analysis. Graduate Texts in Mathematics,            Varin C., Reid N., Firth D., 2011, Statist. Sinica, pp 5‚Äì42",0.0
"    Springer New York, https://books.google.com.na/books?id=                  Virtanen P., et al., 2020, Nature Methods, 17, 261",4.0
"    R6182rh0tKEC                                                              Wes McKinney 2010, in St√©fan van der Walt Jarrod Millman eds, Pro-",4.0
"Kuusela M. J., 2016, PhD thesis, Lausanne, EPFL, doi:10.5075/epfl-thesis-          ceedings of the 9th Python in Science Conference. pp 56 ‚Äì 61,",0.0
"    7118, http://infoscience.epfl.ch/record/220015                                 doi:10.25080/Majora-92bf1922-00a",4.0
"Laureƒ≥s R., et al., 2011, arXiv e-prints, p. arXiv:1110.3193                  Wickham H., Stryjewski L., 2012, Technical report, 40 years of boxplots.",0.0
"Leistedt B., Mortlock D. J., Peiris H. V., 2016, MNRAS, 460, 4258                  had.co.nz",0.0
"Ma Z., Hu W., Huterer D., 2006, ApJ, 636, 21                                  Zhou R., et al., 2020a, arXiv e-prints, p. arXiv:2001.06018",0.0
"Malz A. I., Hogg D. W., 2020, arXiv e-prints, p. arXiv:2007.12178             Zhou R., et al., 2020b, Research Notes of the American Astronomical Soci-",0.0
"Mandelbaum R., 2018, ARA&A, 56, 393                                                ety, 4, 181",0.0
"Matarrese S., Coles P., Lucchin F., Moscardini L., 1997, MNRAS, 286, 115      van Daalen M. P., White M., 2018, MNRAS, 476, 4649",0.0
"McLeod M., Balan S. T., Abdalla F. B., 2017, MNRAS, 466, 3558                 van Rossum G., 1995, Technical Report CS-R9526, Python tutorial. Centrum",0.0
"McQuinn M., White M., 2013, MNRAS, 433, 2857                                       voor Wiskunde en Informatica (CWI), Amsterdam",0.0
"Meister A., 2009, Deconvolution Problems in Nonparametric Statistics. Lec-",0.0
"    ture Notes in Statistics, Springer Berlin Heidelberg, https://books.",4.0
    google.de/books?id=ItGkJPZQj-MC,4.0
"M√©nard B., Scranton R., Schmidt S., Morrison C., Jeong D., Budavari T.,       APPENDIX A: DERIVING THE E-M UPDATE",0.0
"    Rahman M., 2013, arXiv e-prints, p. arXiv:1303.4722                       EQUATIONS",4.0
"Morrison C. B., Hildebrandt H., Schmidt S. J., Baldry I. K., Bilicki M., Choi",0.0
"    A., Erben T., Schneider P., 2017, MNRAS, 467, 3576                        We start the discussion with an intuitive motivation for the theo-",4.0
"Myles J., et al., 2020, arXiv e-prints, p. arXiv:2012.08566                   retical foundation of the E-M algorithm. Assume a ‚Äòsystem‚Äô that",0.0
"Neal R. M., Hinton G. E., 1993, in Learning in Graphical Models. Kluwer       consists of hidden variables ùëå and observed variables ùëç. We wish",0.0
"    Academic Publishers, pp 355‚Äì368                                           to find a set of parameters ùúÉ that maximize the joint distribution of",4.0
"Newman J. A., 2008, ApJ, 684, 88                                              both variables given ùúÉ. We know from statistical physics that the free",0.0
"Newman J. A., et al., 2015, Astroparticle Physics, 63, 81                     energy of this system ùêπ ( ùëù, ùúÉ) should be minimized and depends on",0.0
"Nicola A., et al., 2020, J. Cosmology Astropart. Phys., 2020, 044             the distribution of hidden variables, or states, ùëù(ùë¶) and the parame-",0.0
"Padmanabhan N., et al., 2005, MNRAS, 359, 237                                 ters of the conditional ùëù(ùë¶|ùëß, ùúÉ). The E-M algorithm performs this",0.0
"Pawitan Y., 2001, In All Likelihood: Statistical Modelling and Inference      minimization iteratively, where we assume an initial choice for ùúÉ.",0.0
"    Using Likelihood. Oxford science publications, OUP Oxford, https:",4.0
"                                                                              In the ùê∏-step, we choose a distribution ùëù(ùë¶), while holding ùúÉ fixed,",78.0
    //books.google.com/books?id=M-3pSCVxV5oC,4.0
"                                                                              so that ùêπ ( ùëù, ùúÉ old ) is minimized. In the subsequent ùëÄ-step we hold",78.0
"Perez F., Granger B. E., 2007, Computing in Science Engineering, 9, 21",0.0
"Prat J., et al., 2018, MNRAS, 473, 1667",0.0
"                                                                              ùëù fixed, but choose ùúÉ in a way that ùêπ ( ùëù old , ùúÉ) is minimized. This",78.0
"Quiroz M., Villani M., Kohn R., Tran M.-N., Dang K.-D., 2018, arXiv           procedure is iterated until the free energy does not change much",0.0
"    e-prints, p. arXiv:1807.08409                                             with additional iterations, i.e., the scheme converges. In practical",4.0
"Raccanelli A., Rahman M., Kovetz E. D., 2017, MNRAS, 468, 3650                calculations, the connection with the variational free energy is not",0.0
"Ranganathan A., 2004, Assumed Density Filtering, http://www.ananth.           often used, but it is a useful concept to build up an intuitive under-",0.0
    in/Notes_files/adf.pdf                                                    standing of the method. We refer the interested reader to Neal &,4.0
"                                                                                                                                 MNRAS 000, 1‚Äì22 (2015)",129.0
avr_spaces,15.0
                                                                                                       Likelihood Inference under Photo-z error                                               21,103.0
Hinton (1993) for a more detailed explanation. In the following we                                       E-step: Given an old parameter vector ùúãold we evaluate,0.0
will describe the derivation of the E-M algorithm in the concrete,0.0
"context of finding the maximum likelihood solution of our photo-                                 ùëù(ùúª | FÃÇ,œÄold ) ‚àù                                                                           (A7)",0.0
"metric likelihood. For that we will use a different notation, however                                       ùëÅgal √ñ",0.0
                                                                                                                 ùëÅtot             ‚à´ ùëßùëò               ‚à´ ùõºùëò                                          ! ùúÅùõΩj,113.0
                                                                                                            √ñ                            ùëÖ                   ùëÖ,108.0
"the intuition remains unchanged, if we associate the free energy (up                                                     ùúãj,old             dùëß ùõΩ                dùõº ùõΩ ùëù(f ùõΩ |T (ùëß ùõΩ , ùõº ùõΩ ), Œ£ ùõΩ )        .",0.0
"to a sign) with the term L (ùëû, ùùÖ) in Eq. (A3).                                                              ùõΩ=1 ùëó=1                 ùëß ùêøùëò                 ùõºùêøùëò",0.0
"      To derive the Expectation-Maximization algorithm21 , we first                                                                                                                          (A8)",6.0
introduce the parameter vector Œ∂ùëñ for each galaxy ùëñ that is a ùëÅtot,0.0
dimensional vector to indicate bin membership22 in the ‚Äò1-hot en-                                        M-step: In the maximization step of the algorithm we want to,0.0
"coding‚Äô scheme. This means that for each galaxy, we have a ùëÅtot                                  maximize the expected data log-likelihood with respect to the pa-",0.0
"dimensional binary vector, where (‚Äò0‚Äô/‚Äò1‚Äô) indicates that the galaxy                             rameter ùúª. Given the updated posterior ùëù(ùúª | FÃÇ, œÄold ) this expectation",0.0
(resides/does not reside) in the respective redshift bin. For the re-                            is given as:,0.0
mainder of this section we will work with the normed histogram bin,0.0
heights œÄ = n ùêµ Œîùëß that parametrize the prior distribution over ùëß ‚àí ùõº                                                     ùëÅ      ùëÅtot,0.0
                                                                                                                            gal ‚àëÔ∏Å,124.0
as defined in Eq. 13. The prior distribution over ùúª 23 is then given,0.0
                                                                                                                          ‚àëÔ∏Å                ,122.0
"                                                                                                 ùëÜ (œÄnew , œÄold ) =                     ùê∏ ùúÅùõΩ j √ó",97.0
as                                                                                                                        ùõΩ=1 ùëó=1,0.0
            √ñ     ùëÅgal,12.0
"             ùëÅtot √ñ                                                                                                        ‚à´ ùëßùëó              ‚à´ ùõºùëó                                            !! ,",13.0
                          ùúÅ                                                                                   ,26.0
"ùëù(ùúª |œÄ) ‚àù               ùúã ùëòùëõ,ùëò ,                                                  (A1)             log ùúã ùõΩj + log",0.0
                                                                                                                                  ùëÖ,130.0
                                                                                                                                      dùëß ùõΩ,134.0
                                                                                                                                                      ùëÖ,150.0
"                                                                                                                                                          dùõº ùõΩ ùëù(f ùõΩ |T (ùëß ùõΩ , ùõº ùõΩ ), Œ£ ùõΩ )",154.0
                                                                                                                               ùëó                   ùëó,127.0
            ùëò=1 ùëõ=1                                                                                                          ùëßùêø                ùõºùêø,12.0
        √ç ùëÅtot,8.0
where ùëò=1      ùúã ùëò = 1. Using ùúª we can write the conditional distribu-                                                                                                                       (A9),0.0
tion of the measured photometry given ùúª as                                                       where,0.0
                ùëÅ  gal ùëÅ          ùëò               ùëò,16.0
"                                                                                        ! ùúÅùõΩ,k",88.0
                        tot  ‚à´   ùëßùëÖ         ‚à´   ùõºùëÖ                                                               √ç          ùëõùëò,24.0
"                                                                                               . ùê∏  ùúÅ  = ùúÅùëõ,ùëò ùúÅ ùëù(ùúÅ ùëõùëò | FÃÇ, œÄold )",95.0
                √ñ√ñ,16.0
"ùëù( FÃÇ|ùúª, œÄ) ‚àù                        dùëß ùõΩ             dùõº ùõΩ ùëù(f ùõΩ |T (ùëß ùõΩ , ùõº ùõΩ ), Œ£ ùõΩ )",0.0
                              ùëßùêøùëò             ùõºùêøùëò                                                        ùõΩj        √ç,30.0
"                ùõΩ=1 ùëò=1                                                                                                ùúÅùëõùëò ùëù(ùúÅ ùëõ,ùëò | FÃÇ, œÄold )",16.0
                                                                                  (A2)                                      ‚à´ ùëßùëñ            ‚à´ ùõºùëñ,82.0
"                                                                                                                   ùúãi,old ùëñ ùëÖ dùëß ùõΩ ùëñ ùëÖ dùõº ùõΩ ùëù(f ùõΩ |T (ùëß ùõΩ , ùõº ùõΩ ), Œ£ ùõΩ )",115.0
It is important at this point to note that a marginalization over the                                                        ùëß ùêø              ùõºùêø,0.0
                                                                                                             =                      ùëó,109.0
"parameter vectors ùúÅùëñ for all galaxies will yield the second, i.e. the                                            √ç             ‚à´  ùëß            ‚à´ ùõºùëó",0.0
"                                                                                                                    ùëó ùúãj,old ùëó dùëß",116.0
                                                                                                                                    ùëÖ       ùõΩ,132.0
                                                                                                                                                     ùëó,149.0
                                                                                                                                                       ùëÖ,151.0
"                                                                                                                                                          dùõº ùõΩ ùëù(f ùõΩ |T (ùëß ùõΩ , ùõº ùõΩ ), Œ£ ùõΩ )",154.0
"likelihood, term in Eq. (15).                                                                                                    ùëßùêø               ùõºùêø",0.0
      To derive the iterative optimization scheme we first consider                                                                                                                        (A10),6.0
the decomposition of the posterior as                                                                                                                                               √ç,0.0
"                                                                                                 We optimize ùëÜ nzz,t,new , nzz,t,old under the constraint ùëò ùúã ùëò = 1",97.0
"log ùëù(ùùÖ| FÃÇ) = L (ùëû, ùùÖ) + ùêæ ùêø (ùëû|| ùëù) + log ùëù(ùùÖ) ‚àí log ùëù( FÃÇ) ,                   (A3)",0.0
                                                                                                 using the Lagrange multiplier formalism:,97.0
where                                                                                                                                                                    !,0.0
                                              !                                                                                                              ‚àëÔ∏Å,46.0
"               ‚àëÔ∏Å                   ùëù( FÃÇ, ùúª)                                                    ùëÜ (œÄnew , œÄold ) = ùëÜ (œÄnew , œÄold ) + ùúÜ                          ùúãùëò ‚àí 1",15.0
" L (ùëû, nB ) =         ùëû(ùúª) log                                                    (A4)                                                                                                     (A11)",1.0
                                     ùëû(ùúª)                                                                                                                      ùëò,37.0
                 ùúª,17.0
                                                    !,52.0
"                   ‚àëÔ∏Å                 ùëù(ùúª | FÃÇ, ùùÖ)                                               Equating ‚àáœÄ ùëÜ (œÄnew , œÄold ) == 0, performing a summation over ùëò,",19.0
"ùêæ ùêø(ùëû|| ùëù) = ‚àí          ùëû(ùúª) log                                                  (A5)           and using the summation constraint of œÄ, we obtain",0.0
                                          ùëû(Œ∂),42.0
                    ùúª,20.0
                                                                                                 ‚àíùúÜ = ùëÅgal .                                                                               (A12),97.0
This decomposition implies an iterative scheme to maximize,0.0
"log ùëù(ùùÖ| FÃÇ). Given an initial parameter vector ùùÖ old , we first minimize                        This leads to the update equations for the E-M scheme that are",0.0
"ùêæ ùêø(ùëû|| ùëù) in the ‚ÄòE-step‚Äô which directly implies ùëû(Œ∂) = ùëù(ùúª | FÃÇ, ùùÖ).                           iterated until we reach convergence in œÄ 24 :",0.0
"In the ‚ÄòM‚Äô-step we fix the distribution ùëû(Œ∂) and maximize L (ùëû, ùùÖ).",0.0
This maximization directive is then given as                                                                                      ‚à´ ùëßùëò         ‚à´ ùõºùëò,0.0
"                                                                                                                                     ùëò dùëß ùëñ ùõº ùëò dùõºùëñ ùëù( fÃÇi |T (ùëß ùëñ , ùõºùëñ ), Œ£ùëñ )",133.0
                                                                                                                 ùëÅ                     ùëÖ               ùëÖ,113.0
                                                                                                                   gal ¬©                                                                         ¬™,115.0
                            ‚àëÔ∏Å                                                                     ùë°      ùë°‚àí1,16.0
                                                                                                                 ‚àëÔ∏Å    ¬≠           ùëß                                                             ¬Æ,113.0
"L (ùëû, ùùÖ) = ùëÜ ùùÖ, ùùÖ old =              ùëù(ùúª | FÃÇ, ùùÖ old ) log ùëù( FÃÇ, ùúª |ùùÖ) + const. ,",0.0
                                                                                                                                     ùêø               ùêø,133.0
                                                                                                 ùëÅùëò = ùúãùëò               ¬≠,97.0
                                                                                                                       ¬≠√ç                       ùëó               ùëó,119.0
                                                                                                                                                                                                 ¬Æ,193.0
                                                                                                                                                                                                 ¬Æ,193.0
                                                                                                                            ùëÅ        ùë°‚àí1,124.0
                                                                                                                                           ‚à´  ùëßùëÖ           ‚à´  ùõºùëÖ,139.0
"                                                                                                                                                               ùëó dùõºùëñ ùëù( fÃÇi |T (ùëß ùëñ , ùõºùëñ ), Œ£ùëñ )",159.0
                                                                                                                 ùëñ=1   ¬≠      tot                                                                ¬Æ,113.0
                                  ùúª                                                                                         ùëó=1 ùëó,34.0
                                                                                                                                   ùúã          ùëó dùëß ùëñ,131.0
                                                                                                                       ¬´                     ùëßùêø              ùõºùêø                                  ¬¨,119.0
                                                                                  (A6)                                                                                                     (A13),82.0
which is the expectation of the data log-likelihood with respect to                                          ùëÅ ùë°‚àí1,0.0
"ùúª. After a new parameter vector ùùÖ new is obtained, we continue with                               ùúã ùë°ùëò = √ç ùëò ùë°‚àí1 .                                                                         (A14)",0.0
the ‚ÄòE‚Äô-step holding ùùÖ new fixed. This process is continued until                                            ùëò ùëÅùëò,0.0
convergence. In the following we will derive the corresponding,0.0
                                                                                                         In appendix B we will derive a Laplace approximation to the,105.0
update equations.,0.0
                                                                                                 posterior based on this optimization scheme. We apply and discuss,97.0
                                                                                                 this scheme in ¬ß 4 and ¬ß 8.,97.0
21  The interested reader will find the following derivation in analogy to the,0.0
derivation to the E-M update equations for the Gaussian Mixture model (see,0.0
Bishop 2006).,0.0
22 We are referring to bins as defined in Eq. (13).                                              24    In practice we would iterate until the log-likelihood changes only by an,0.0
"23 Here, ùúª denotes the collection of Œ∂ vectors of all galaxies.                                  extremely small amount.",0.0
"MNRAS 000, 1‚Äì22 (2015)",0.0
avr_spaces,51.845454545454544
22,0.0
"APPENDIX B: DERIVING THE LAPLACE                                                                   Transformed into probability, or simplex, space, this posterior is",0.0
APPROXIMATION                                                                                      then identified as a logit-normal distribution,0.0
In the previous appendix we derived an iterative scheme to obtain                                                  1            1,0.0
                                                                                                   ùëù(ùùÖ| FÃÇ) ‚âà ‚àöÔ∏Å          √é ùëÅbins                                      (B11),99.0
maximum likelihood estimates of the vector of normed histogram                                                   |2ùúãùö∫y |           ùúãùëñ,0.0
                                                                                                                             ùëñ=1,125.0
heights ùùÖ ML based on the E-M algorithm. We note that the E-M,0.0
                                                                                                                       ùùÖ ‚àíNbins                         ùùÖ ‚àíNbins,119.0
                                                                                                                                                                    ,104.0
"algorithm is guaranteed to produce a maximum likelihood estimate                                    exp ‚àí0.5 log                  ‚àí ùùÅy,ML ùö∫‚àí1y    log              ‚àí ùùÅ y,ML .",0.0
ùùÖ ML that lies on the simplex. The direct application of the Laplace                                                   ùúã ùëÅbins                          ùúã ùëÅbins,0.0
approximation will effectively estimate Gaussian errors on the val-                                                                                                    (B12),0.0
ues. Applying this approximation around ùúãML will lead to posteriors                                We note that the logit-normal is a probability distribution on the,0.0
"that reach to negative values, i.e. the posterior draws are not guar-                              simplex, just as the Dirichlet. In fact, the Dirichlet can be approxi-",0.0
anteed to lie on the simplex. To extend the Laplace approximation                                  mated well by a logit-normal (Atchison & Shen 1980). However the,0.0
"to random variables that lie on the simplex, we first consider a                                   logit-normal allows for a more complex covariance structure. The",0.0
mapping from simplex space to R ùëÅbins ‚àí1 . This mapping is realized                                scheme developed in this appendix is applied and analysed in ¬ß 4,0.0
"by the additive logistic transformation. Assume y ‚àà R ùëÅbins ‚àí1 , we                                and ¬ß 8.",0.0
define the function,0.0
                                                                                              !ùëá   This paper has been typeset from a TEX/LATEX file prepared by the author.,94.0
                       ùëí ùë¶1                               ùëí ùë¶Nbins ‚àí1             1,23.0
"ùùÖ(y) =              √ç ùëÅbins ‚àí1 ùë¶        ,  .  .  . ,      √ç ùëÅbins ‚àí1 ùë¶     ,   √ç ùëÅbins ‚àí1 ùë¶      ,",0.0
             1 + ùëñ=1                ùëí ùëñ              1 + ùëñ=1           ùëí ùëñ 1 + ùëñ=1        ùëí ùëñ,13.0
                                                                                         (B1),89.0
with its inverse,0.0
                                                                            ,11.0
"y(ùùÖ) = log (ùúã1 /ùúã ùëÅbins ), . . . , log (ùúã ùëÅbins ‚àí1 /ùúã ùëÅbins ) .                          (B2)",0.0
       We see that the transformed variables y are now defined in real,7.0
space and we perform the Laplace approximation as usual. Assum-,0.0
"ing a flat prior in logistic space, we can directly utilize the invariance",0.0
of the Maximum Likelihood estimate under variable transforma-,0.0
tions (see e.g. Pawitan 2001) and approximate the posterior,0.0
"ùëù(y| FÃÇ) = N (y| ùùÅML , ùö∫) ,                                                              (B3)",0.0
where,0.0
"ùùÅy ML = y(ùùÖ ML ) ,                                                                       (B4)",0.0
and,0.0
ùö∫ùíö = ‚àí H‚àí1                      .                                                        (B5),0.0
                    y=yML,20.0
Here H is the hessian of the log-likelihood (the second term in,0.0
Eq. (15)) as a function of y evaluated at y(ùùÖ ML ).,0.0
       The components of the hessian are given as,7.0
                     √ç                    √ç                       ,21.0
             ùëÅ  gal,13.0
                          ùëÅtot ùúï ùúã ùëó                      ùëÅtot ùúï ùúã ùëó,26.0
             ‚àëÔ∏Å           ùëó         ùúïùë¶ùëß      ùêº  ùëñ ùëó       ùëó=1 ùúïùë¶ùëé ùëñ ùëó,13.0
                                                                         ùêº,73.0
ùêª ùëéùëß = ‚àí                               √ç                   2                           (B6),0.0
             ùëñ=1                             ùëÅtot,13.0
                                                     ùúã,53.0
                                             ùëó=1 ùëó ùëñ ùëó,45.0
                                                        ùêº,56.0
          ùëÅ gal                          ùëÅ,10.0
                                                               !,63.0
          ‚àëÔ∏Å               1            ‚àëÔ∏Å  tot,10.0
                                                      ùúï2 ùúã ùëó,54.0
"       +         √ç                                              ùêºùëñ ùëó ,                 (B7)",7.0
                      ùëÅtot,22.0
                             ùúã ùêº                     ùúïùë¶ ùëé ùúïùë¶ ùëß,29.0
          ùëñ=1         ùëó=1        ùëó ùëñùëó     ùëó=1,10.0
where,0.0
        ‚à´ ùëßùëó           ‚à´ ùõºùëó,8.0
              ùëÖ                  ùëÖ,14.0
ùêºùëñ ùëó = ùëó dùëßùëñ                  ùëó,0.0
"                                    dùõºùëñ ùëù( fÃÇi |T (ùëß ùëñ , ùõºùëñ ), Œ£ùëñ ) .                    (B8)",36.0
          ùëßùêø               ùõºùêø,10.0
The first and second order derivatives are then evaluated to,0.0
"          Ô£± ùúãùëñ (1 ‚àí ùúãùëñ ),",10.0
          Ô£¥                                     ùëñ = ùëó ‚àß ùëñ < ùëÅùê∑,10.0
 ùúïùúã ùëñ Ô£¥,1.0
          Ô£¥,10.0
                ‚àíùúã                              ùëñ ‚â† ùëó ‚àß ùëñ < ùëÅùê∑,16.0
          Ô£≤,10.0
"       =            ùëñ ùúã ùëó ,                                                              (B9)",7.0
 ùúïùë¶ ùëó Ô£¥                     ùúãùëó,1.0
          Ô£¥     ‚àí     √ç,10.0
"          Ô£¥ 1+ ùê∑‚àí1 exp ùë¶ùëß               ,       ùëñ   = ùëÅùê∑",10.0
          Ô£≥             ùëß=1,10.0
and,0.0
                       ùúï ùúãùëñ              ùúï ùúãùëñ,23.0
"                       ùúïùë¶ ùõº ‚àí 2ùúãùëñ ùúïùë¶ ùõº ,                   ùëñ = ùëó ‚àß ùëñ < ùëÅùê∑",23.0
                  Ô£±,18.0
                  Ô£¥,18.0
                  Ô£¥,18.0
                  Ô£¥,18.0
     2,5.0
"   ùúï ùúã  ùëñ         Ô£≤ ‚àí ùëñ ùúã ‚àí ùúã ùúïùúãùëó , ùëñ ‚â† ùëó ‚àß ùëñ < ùëÅ",3.0
                  Ô£¥,18.0
                  Ô£¥       ùúï  ùúã,18.0
              =           ùúïùë¶ ùõº ùëó,14.0
                                     ùúïùúã,37.0
                                             ùëñ ùúïùë¶ ùõº                          ùê∑          (B10),45.0
 ùúïùë¶ ùõº ùúïùë¶ ùëó Ô£¥      Ô£¥       ùúã ùëó ùúã ùõº ‚àí ùúïùë¶ ùõºùëó,1.0
                                                           ùëñ = ùëÅùê∑,59.0
                  Ô£¥,18.0
                  Ô£¥,18.0
"                  Ô£¥        √ç                   ,",18.0
                  Ô£≥ 1+ ùê∑‚àí1    ùëß=1 exp ùë¶ùëß,18.0
"                                                                                                                                                   MNRAS 000, 1‚Äì22 (2015)",147.0
avr_spaces,19.29
